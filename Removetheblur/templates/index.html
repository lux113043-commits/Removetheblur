<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å›¾ç‰‡èƒŒæ™¯ä¿®å¤å·¥å…·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #7EBEFB 0%, #5A9FD8 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #7EBEFB 0%, #5A9FD8 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .content {
            padding: 40px;
        }

        .input-section {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
            font-size: 1.1em;
        }

        .form-group input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #7EBEFB;
        }

        .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
            resize: vertical;
            min-height: 80px;
            font-family: inherit;
        }

        .form-group textarea:focus {
            outline: none;
            border-color: #7EBEFB;
        }

        .btn {
            background: linear-gradient(135deg, #7EBEFB 0%, #5A9FD8 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.1em;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            font-weight: bold;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(126, 190, 251, 0.4);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* é¡¶éƒ¨åˆ†é¡µï¼ˆTabï¼‰ */
        .tab-nav {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 15px 0 25px;
            flex-wrap: wrap;
        }

        .tab-btn {
            background: white;
            border: 2px solid #7EBEFB;
            color: #5A9FD8;
            padding: 10px 18px;
            border-radius: 999px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s;
        }

        .tab-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 18px rgba(126, 190, 251, 0.25);
        }

        .tab-btn.active {
            background: linear-gradient(135deg, #7EBEFB 0%, #5A9FD8 100%);
            color: white;
            border-color: transparent;
        }

        .channel-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            margin-bottom: 18px;
        }

        .channel-title {
            font-size: 1.05em;
            font-weight: bold;
            color: #333;
            margin-bottom: 12px;
        }

        .hint-box {
            margin-top: 10px;
            padding: 12px 14px;
            background: #E6F4FD;
            border-left: 4px solid #7EBEFB;
            border-radius: 10px;
            color: #245b86;
            line-height: 1.6;
        }

        .status-section {
            background: #fff;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            border-left: 4px solid #7EBEFB;
        }

        .status-item {
            margin: 10px 0;
            font-size: 1em;
        }

        .status-item strong {
            color: #5A9FD8;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e9ecef;
            border-radius: 15px;
            overflow: hidden;
            margin: 15px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #7EBEFB 0%, #5A9FD8 100%);
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .images-section {
            margin-top: 30px;
        }

        .file-manager-container {
            display: flex;
            gap: 20px;
            margin-top: 20px;
            height: 70vh;
            min-height: 600px;
        }

        .thumbnail-panel {
            width: 300px;
            background: #f8f9fa;
            border-radius: 15px;
            padding: 15px;
            overflow-y: auto;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .thumbnail-panel h3 {
            margin-bottom: 15px;
            color: #333;
            font-size: 1.1em;
            padding-bottom: 10px;
            border-bottom: 2px solid #7EBEFB;
        }

        .thumbnail-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .thumbnail-item {
            background: white;
            border-radius: 8px;
            padding: 8px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .thumbnail-item:hover {
            background: #E6F4FD;
            border-color: #7EBEFB;
            transform: translateX(5px);
        }

        .thumbnail-item.active {
            background: #E6F4FD;
            border-color: #7EBEFB;
            box-shadow: 0 2px 8px rgba(126, 190, 251, 0.3);
        }

        .thumbnail-item img {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 6px;
        }

        .thumbnail-item .thumbnail-info {
            flex: 1;
            min-width: 0;
        }

        .thumbnail-item .thumbnail-name {
            font-size: 0.9em;
            color: #333;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 4px;
        }

        .thumbnail-item .thumbnail-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .preview-panel {
            flex: 1;
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            overflow-y: auto;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
        }

        .preview-panel h3 {
            margin-bottom: 15px;
            color: #333;
            font-size: 1.1em;
            padding-bottom: 10px;
            border-bottom: 2px solid #7EBEFB;
        }

        .preview-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 400px;
        }

        .preview-image-container {
            width: 100%;
            max-width: 1200px;
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .preview-image-container img {
            width: 100%;
            height: auto;
            border-radius: 8px;
            display: block;
        }

        .preview-comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            width: 100%;
        }

        .preview-image-wrapper {
            background: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            width: 100%;
        }

        .preview-image-wrapper img {
            width: 100%;
            height: auto;
            border-radius: 8px;
            max-height: 600px;
            object-fit: contain;
        }

        .preview-image-wrapper img.zoomable-fixed {
            cursor: zoom-in;
        }

        .preview-label {
            text-align: center;
            margin-top: 10px;
            font-weight: bold;
            color: #5A9FD8;
        }

        .images-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(600px, 1fr));
            gap: 30px;
            margin-top: 20px;
        }

        .image-card {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: relative;
            transition: all 0.3s;
        }

        .image-card.selected {
            background: #E6F4FD;
            border: 2px solid #7EBEFB;
            box-shadow: 0 4px 20px rgba(126, 190, 251, 0.3);
        }

        .image-card h3 {
            margin-bottom: 15px;
            color: #333;
            font-size: 1.2em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .image-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .comparison-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
        }

        .image-wrapper {
            position: relative;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .image-wrapper img {
            width: 100%;
            height: auto;
            display: block;
        }

        .image-label {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 8px;
            text-align: center;
            font-size: 0.9em;
        }

        .error-message {
            background: #fee;
            color: #c33;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid #c33;
        }

        .success-message {
            background: #efe;
            color: #3c3;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid #3c3;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #7EBEFB;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state svg {
            width: 100px;
            height: 100px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        /* å›¾ç‰‡æ”¾å¤§é¢„è§ˆï¼ˆåŒå‡» + æ»šè½®ç¼©æ”¾ï¼‰ */
        .zoom-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.75);
        }

        .zoom-modal-content {
            position: relative;
            width: 92%;
            height: 92%;
            margin: 2% auto;
            background: rgba(255, 255, 255, 0.06);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 14px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.35);
            overflow: hidden;
        }

        .zoom-close {
            position: absolute;
            right: 14px;
            top: 10px;
            color: rgba(255,255,255,0.9);
            font-size: 32px;
            font-weight: bold;
            cursor: pointer;
            user-select: none;
            z-index: 2002;
        }

        .zoom-hint {
            position: absolute;
            left: 14px;
            top: 14px;
            color: rgba(255,255,255,0.92);
            font-size: 13px;
            padding: 8px 10px;
            background: rgba(0,0,0,0.35);
            border-radius: 10px;
            z-index: 2002;
            user-select: none;
        }

        .zoom-canvas {
            position: absolute;
            left: 0;
            top: 0;
            right: 0;
            bottom: 0;
            overflow: hidden;
            cursor: grab;
        }

        .zoom-canvas.dragging {
            cursor: grabbing;
        }

        /* æ”¾å¤§é¢„è§ˆå±‚
           å¤–å±‚è´Ÿè´£ translateï¼ˆå±å¹•åæ ‡ï¼‰ï¼Œå†…å±‚è´Ÿè´£ scaleï¼ˆå›¾åƒåæ ‡ï¼‰ */
        #zoomLayerOuter {
            position: absolute;
            left: 0;
            top: 0;
            transform: translate(0px, 0px);
            transform-origin: 0 0;
        }

        #zoomLayerInner {
            position: absolute;
            left: 0;
            top: 0;
            transform-origin: 0 0;
            user-select: none;
            -webkit-user-drag: none;
        }

        #zoomImage {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            max-width: none;
            max-height: none;
            user-select: none;
            -webkit-user-drag: none;
            pointer-events: none; /* è®©æ‹–æ‹½/æ»šè½®äº‹ä»¶è½åœ¨ç”»å¸ƒä¸Š */
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ–¼ï¸ å›¾ç‰‡èƒŒæ™¯ä¿®å¤å·¥å…·</h1>
            <p>ä½¿ç”¨AIè‡ªåŠ¨ä¿®å¤å›¾ç‰‡èƒŒæ™¯ï¼Œè¾“å‡º1024Ã—1536æ¸…æ™°å›¾ç‰‡</p>
        </div>

        <div class="tab-nav">
            <button class="tab-btn active" id="tabAiBtn" onclick="switchMainTab('ai')">AIä¿®å¤</button>
            <button class="tab-btn" id="tabResizeBtn" onclick="switchMainTab('resize')">å°ºå¯¸é€šé“</button>
        </div>

        <div class="content" id="aiPage">
            <div class="input-section">
                <div class="form-group">
                    <label for="inputFolder">ğŸ“ å›¾ç‰‡æ–‡ä»¶å¤¹è·¯å¾„ï¼š</label>
                    <input type="text" id="inputFolder" placeholder="ä¾‹å¦‚: D:\Photos\input_images" />
                </div>
                <div class="form-group">
                    <label for="promptInput">ğŸ“ æç¤ºè¯ï¼ˆå¯ä¿®æ”¹ï¼‰ï¼š</label>
                    <textarea id="promptInput" placeholder="è¯·è¾“å…¥æç¤ºè¯ï¼ˆä¸å¡«åˆ™ä½¿ç”¨é»˜è®¤æç¤ºè¯ï¼‰">{{ default_prompt|e }}</textarea>
                    <small style="display:block; margin-top: 6px; color:#666; line-height: 1.4;">
                        ä¸å¡«ä¼šä½¿ç”¨é»˜è®¤æç¤ºè¯ï¼›ä¿®æ”¹åä¼šæŒ‰ä½ å¡«å†™çš„æç¤ºè¯ç”Ÿæˆã€‚
                    </small>
                </div>
                <button class="btn" id="processBtn" onclick="startProcessing()">
                    ğŸš€ å¼€å§‹å¤„ç†
                </button>
            </div>

            <div class="status-section" id="statusSection" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h2 style="margin: 0;">å¤„ç†çŠ¶æ€</h2>
                    <button class="btn" onclick="showTaskReport()" id="taskReportBtn" style="padding: 8px 20px; font-size: 0.9em; background: linear-gradient(135deg, #5A9FD8 0%, #7EBEFB 100%);">
                        ğŸ“Š ä»»åŠ¡æŠ¥å‘Š
                    </button>
                </div>
                <div class="status-item">
                    <strong>å½“å‰æ–‡ä»¶ï¼š</strong> <span id="currentFile">-</span>
                </div>
                <div class="status-item">
                    <strong>è¿›åº¦ï¼š</strong> <span id="progress">0 / 0</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 0%">0%</div>
                </div>
                <div id="statusMessage"></div>
            </div>

            <div class="images-section" id="imagesSection" style="display: block;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;">
                    <h2 style="margin: 0;">å¤„ç†ç»“æœå¯¹æ¯”</h2>
                </div>
                <div id="autoSaveInfo" style="margin-bottom: 15px; color: #2e7d32; font-weight: bold; padding: 12px; background: #e8f5e9; border-radius: 8px; border-left: 4px solid #4caf50;">
                    ğŸ’¾ å›¾ç‰‡å°†è‡ªåŠ¨ä¿å­˜åˆ°è¾“å…¥æ–‡ä»¶å¤¹ä¸‹çš„"ç›´æ¥æŠ•å…¥ä½¿ç”¨"å­æ–‡ä»¶å¤¹
                </div>
                
                <!-- æ–‡ä»¶ç®¡ç†å’Œé¢„è§ˆåŒºåŸŸ -->
                <div class="file-manager-container" id="fileManagerContainer" style="display: flex;">
                    <div class="thumbnail-panel">
                        <h3>ğŸ“ å›¾ç‰‡åˆ—è¡¨</h3>
                        <div class="thumbnail-list" id="thumbnailList">
                            <div class="empty-state" style="padding: 40px 20px; text-align: center; color: #999;">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" style="width: 60px; height: 60px; margin: 0 auto 15px; opacity: 0.3;">
                                    <rect x="3" y="3" width="18" height="18" rx="2" stroke-width="2"/>
                                    <path d="M9 9h6v6H9z" stroke-width="2"/>
                                </svg>
                                <p style="font-size: 0.95em; line-height: 1.6;">
                                    <strong>ç­‰å¾…å›¾ç‰‡å¤„ç†</strong><br>
                                    å¤„ç†å®Œæˆåï¼Œè¿™é‡Œå°†æ˜¾ç¤ºæ‰€æœ‰å›¾ç‰‡çš„ç¼©ç•¥å›¾åˆ—è¡¨
                                </p>
                            </div>
                        </div>
                    </div>
                    <div class="preview-panel">
                        <h3>ğŸ–¼ï¸ å›¾ç‰‡é¢„è§ˆ</h3>
                        <div class="preview-content" id="previewContent">
                            <div class="empty-state" style="padding: 60px 40px; text-align: center; color: #999;">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" style="width: 100px; height: 100px; margin: 0 auto 20px; opacity: 0.3;">
                                    <rect x="3" y="3" width="18" height="18" rx="2" stroke-width="2"/>
                                    <circle cx="8.5" cy="8.5" r="1.5" stroke-width="2"/>
                                    <path d="M21 15l-5-5L5 21" stroke-width="2"/>
                                </svg>
                                <p style="font-size: 1.1em; margin-bottom: 15px; font-weight: bold; color: #666;">åŠŸèƒ½è¯´æ˜</p>
                                <div style="text-align: left; color: #666; line-height: 2; max-width: 500px; margin: 0 auto;">
                                    <p>ğŸ“‹ <strong>å·¦ä¾§ï¼š</strong>å›¾ç‰‡ç¼©ç•¥å›¾åˆ—è¡¨ï¼Œæ˜¾ç¤ºæ‰€æœ‰å¤„ç†åçš„å›¾ç‰‡</p>
                                    <p>ğŸ–¼ï¸ <strong>å³ä¾§ï¼š</strong>ç‚¹å‡»ç¼©ç•¥å›¾åï¼Œè¿™é‡Œæ˜¾ç¤ºåŸå›¾ä¸ä¿®å¤åçš„å¯¹æ¯”å¤§å›¾</p>
                                    <p>ğŸ’¾ <strong>è‡ªåŠ¨ä¿å­˜ï¼š</strong>æ¯ç”Ÿæˆä¸€å¼ å›¾ç‰‡å°†è‡ªåŠ¨ä¿å­˜åˆ°è¾“å…¥æ–‡ä»¶å¤¹ä¸‹çš„"ç›´æ¥æŠ•å…¥ä½¿ç”¨"å­æ–‡ä»¶å¤¹</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- åŸæ¥çš„ç½‘æ ¼è§†å›¾ï¼ˆå¤‡ç”¨ï¼‰ -->
                <div class="images-grid" id="imagesGrid" style="display: none;">
                    <div class="empty-state">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" style="width: 80px; height: 80px; margin-bottom: 20px; opacity: 0.3;">
                            <rect x="3" y="3" width="18" height="18" rx="2" stroke-width="2"/>
                            <path d="M9 9h6v6H9z" stroke-width="2"/>
                        </svg>
                        <p style="font-size: 1.1em; margin-bottom: 10px; font-weight: bold;">ğŸ“‹ åŠŸèƒ½è¯´æ˜</p>
                        <div style="text-align: left; color: #666; line-height: 1.8; max-width: 600px; margin: 0 auto;">
                            <p>1. è¾“å…¥å›¾ç‰‡æ–‡ä»¶å¤¹è·¯å¾„ï¼Œç‚¹å‡»"å¼€å§‹å¤„ç†"</p>
                            <p>2. å¤„ç†å®Œæˆåï¼Œå·¦ä¾§æ˜¾ç¤ºç¼©ç•¥å›¾åˆ—è¡¨ï¼Œå³ä¾§æ˜¾ç¤ºå¤§å›¾é¢„è§ˆ</p>
                            <p>3. æ¯ç”Ÿæˆä¸€å¼ å›¾ç‰‡å°†è‡ªåŠ¨ä¿å­˜åˆ°ï¼š<code style="background: #f0f0f0; padding: 2px 6px; border-radius: 4px;">è¾“å…¥æ–‡ä»¶å¤¹/ç›´æ¥æŠ•å…¥ä½¿ç”¨/</code></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- å°ºå¯¸é€šé“é¡µï¼šå‹ç¼©é—®é¢˜ / åŸå›¾é—®é¢˜ -->
        <div class="content" id="resizePage" style="display: none;">
            <div class="input-section">
                <h2 style="margin-top:0; margin-bottom: 10px;">ğŸ“ å°ºå¯¸é€šé“ï¼ˆä¸æ”¹å˜æ¸…æ™°ç¨‹åº¦çš„é«˜è´¨é‡ç¼©æ”¾ï¼‰</h2>
                <div class="hint-box">
                    - **å‹ç¼©é—®é¢˜**ï¼šè¾“å‡ºå°ºå¯¸å›ºå®šä¸º <strong>1026Ã—1539</strong>ï¼ˆç¼©å°ï¼‰<br>
                    - **åŸå›¾é—®é¢˜**ï¼šè¾“å‡ºå°ºå¯¸å›ºå®šä¸º <strong>2160Ã—3240</strong>ï¼ˆæ”¾å¤§ï¼‰<br>
                    è¾“å‡ºä¼šåˆ†åˆ«ä¿å­˜åˆ°ä½ è¾“å…¥æ–‡ä»¶å¤¹ä¸‹çš„å­æ–‡ä»¶å¤¹ï¼š<code>å‹ç¼©é—®é¢˜_1026x1539</code> / <code>åŸå›¾é—®é¢˜_2160x3240</code>ã€‚
                </div>

                <div class="channel-card" style="margin-top: 16px;">
                    <div class="channel-title">ğŸ”§ æ¸…æ™°åº¦å¢å¼ºï¼ˆå¯é€‰ï¼‰</div>
                    <div style="display:flex; align-items:center; gap: 12px; flex-wrap: wrap;">
                        <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">
                            <input type="checkbox" id="resizeSharpenEnabled" checked>
                            <span><strong>å¢å¼ºé”åº¦</strong>ï¼ˆæ”¾å¤§æ›´æ˜æ˜¾ï¼Œå¯èƒ½ä¼šæœ‰è½»å¾®è¾¹ç¼˜å¼ºåŒ–ï¼‰</span>
                        </label>
                        <div style="display:flex; align-items:center; gap:10px; flex: 1; min-width: 260px;">
                            <span style="white-space:nowrap; color:#666;">å¼ºåº¦</span>
                            <input type="range" id="resizeSharpenStrength" min="0" max="150" value="15" style="flex: 1;">
                            <span id="resizeSharpenStrengthValue" style="min-width: 48px; text-align:right; color:#333; font-weight:bold;">15%</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="channel-card">
                <div class="channel-title">é€šé“ Aï¼šå‹ç¼©é—®é¢˜ï¼ˆç¼©å°åˆ° 1026Ã—1539ï¼‰</div>
                <div class="form-group">
                    <label for="compressedFolder">ğŸ“ å›¾ç‰‡æ–‡ä»¶å¤¹è·¯å¾„ï¼š</label>
                    <input type="text" id="compressedFolder" placeholder="ä¾‹å¦‚: D:\Photos\compressed_issue" />
                </div>
                <button class="btn" id="startCompressedBtn" onclick="startResize('compressed')" style="padding: 12px 28px;">
                    â–¶ å¼€å§‹ç¼©æ”¾ï¼ˆå‹ç¼©é—®é¢˜ï¼‰
                </button>
            </div>

            <div class="channel-card">
                <div class="channel-title">é€šé“ Bï¼šåŸå›¾é—®é¢˜ï¼ˆæ”¾å¤§åˆ° 2160Ã—3240ï¼‰</div>
                <div class="form-group">
                    <label for="originalIssueFolder">ğŸ“ å›¾ç‰‡æ–‡ä»¶å¤¹è·¯å¾„ï¼š</label>
                    <input type="text" id="originalIssueFolder" placeholder="ä¾‹å¦‚: D:\Photos\original_issue" />
                </div>
                <button class="btn" id="startOriginalBtn" onclick="startResize('original')" style="padding: 12px 28px;">
                    â–¶ å¼€å§‹ç¼©æ”¾ï¼ˆåŸå›¾é—®é¢˜ï¼‰
                </button>
            </div>

            <div class="status-section" id="resizeStatusSection" style="display: none;">
                <div style="display:flex; justify-content: space-between; align-items:center; margin-bottom: 10px; gap: 10px; flex-wrap: wrap;">
                    <h2 style="margin: 0;">å°ºå¯¸é€šé“çŠ¶æ€</h2>
                    <div style="color:#666;">
                        <strong>è¾“å‡ºæ–‡ä»¶å¤¹ï¼š</strong><span id="resizeOutputFolder">-</span>
                    </div>
                </div>
                <div class="status-item">
                    <strong>æ¨¡å¼ï¼š</strong> <span id="resizeMode">-</span>
                </div>
                <div class="status-item">
                    <strong>å½“å‰æ–‡ä»¶ï¼š</strong> <span id="resizeCurrentFile">-</span>
                </div>
                <div class="status-item">
                    <strong>è¿›åº¦ï¼š</strong> <span id="resizeProgress">0 / 0</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="resizeProgressFill" style="width: 0%">0%</div>
                </div>
                <div id="resizeStatusMessage"></div>

                <div style="margin-top: 16px;">
                    <div style="display:flex; justify-content: space-between; align-items:center; gap: 10px; flex-wrap: wrap;">
                        <h3 style="margin: 0; color:#333;">ğŸ“‹ ä»»åŠ¡æ—¥å¿—</h3>
                        <button class="btn" onclick="clearResizeLogUI()" style="padding: 8px 16px; font-size: 0.9em; background: white; color:#5A9FD8; border: 2px solid #7EBEFB;">
                            æ¸…ç©ºæ—¥å¿—æ˜¾ç¤º
                        </button>
                    </div>
                    <div id="resizeLogList" style="margin-top: 10px; background:#0b1220; color:#d6e2ff; border-radius: 12px; padding: 12px; max-height: 220px; overflow:auto; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace; font-size: 12px; line-height: 1.6;">
                        <div style="opacity:0.8;">æš‚æ— æ—¥å¿—</div>
                    </div>
                </div>

                <div style="margin-top: 16px;">
                    <div style="display:flex; justify-content: space-between; align-items:center; gap: 10px; flex-wrap: wrap;">
                        <h3 style="margin: 0; color:#333;">ğŸ–¼ï¸ è¾“å‡ºæ–‡ä»¶å¤¹é¢„è§ˆ</h3>
                        <button class="btn" onclick="loadResizePreview(true)" style="padding: 8px 16px; font-size: 0.9em;">
                            åˆ·æ–°é¢„è§ˆ
                        </button>
                    </div>
                    <div id="resizePreviewMeta" style="margin-top: 8px; color:#666;">-</div>
                    <div id="resizePreviewGrid" style="margin-top: 10px; display:grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 12px;">
                        <div class="empty-state" style="padding: 24px 10px;">
                            <p style="margin:0;">æš‚æ— é¢„è§ˆ</p>
                        </div>
                    </div>
                    <div style="margin-top: 10px; color:#666; font-size: 0.9em;">
                        æç¤ºï¼šç‚¹å‡»ç¼©ç•¥å›¾å¯é¢„è§ˆï¼ˆæ»šè½®ç¼©æ”¾ï¼‰ã€‚
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æ”¾å¤§é¢„è§ˆæ¨¡æ€æ¡† -->
    <div id="imageZoomModal" class="zoom-modal" aria-hidden="true">
        <div class="zoom-modal-content">
            <div class="zoom-hint">ç‚¹å‡»é¢„è§ˆ Â· æ»šè½®ç¼©æ”¾ Â· æ‹–æ‹½ç§»åŠ¨ Â· ESC å…³é—­</div>
            <div id="zoomClose" class="zoom-close">&times;</div>
            <div id="zoomCanvas" class="zoom-canvas">
                <div id="zoomLayerOuter">
                    <div id="zoomLayerInner">
                        <img id="zoomImage" alt="é¢„è§ˆå›¾ç‰‡" />
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let statusCheckInterval = null;
        let imagesCheckInterval = null;
        let resizeCheckInterval = null;
        let currentSessionId = '';
        let currentOutputFolder = '';
        let currentPreviewIndex = -1;
        let allImagesData = [];  // å­˜å‚¨æ‰€æœ‰å›¾ç‰‡æ•°æ®

        function startProcessing() {
            try {
                const inputFolder = document.getElementById('inputFolder');
                if (!inputFolder) {
                    alert('é”™è¯¯: æ‰¾ä¸åˆ°è¾“å…¥æ¡†å…ƒç´ ');
                    console.error('æ‰¾ä¸åˆ° inputFolder å…ƒç´ ');
                    return;
                }
                
                const folderPath = inputFolder.value.trim();
                const promptEl = document.getElementById('promptInput');
                const promptText = promptEl ? (promptEl.value || '').trim() : '';
                
                if (!folderPath) {
                    alert('è¯·è¾“å…¥å›¾ç‰‡æ–‡ä»¶å¤¹è·¯å¾„');
                    return;
                }

                const btn = document.getElementById('processBtn');
                if (!btn) {
                    alert('é”™è¯¯: æ‰¾ä¸åˆ°å¤„ç†æŒ‰é’®');
                    console.error('æ‰¾ä¸åˆ° processBtn å…ƒç´ ');
                    return;
                }
                
                btn.disabled = true;
                btn.textContent = 'â³ å¤„ç†ä¸­...';

            // æ˜¾ç¤ºçŠ¶æ€åŒºåŸŸ
            const statusSection = document.getElementById('statusSection');
            const imagesSection = document.getElementById('imagesSection');
            const fileManagerContainer = document.getElementById('fileManagerContainer');
            const imagesGrid = document.getElementById('imagesGrid');
            
            if (statusSection) statusSection.style.display = 'block';
            if (imagesSection) imagesSection.style.display = 'block';
            if (fileManagerContainer) fileManagerContainer.style.display = 'flex';
            if (imagesGrid) imagesGrid.style.display = 'none';
            
            // æ›´æ–°ç¼©ç•¥å›¾åˆ—è¡¨æ˜¾ç¤ºå¤„ç†ä¸­çŠ¶æ€
            const thumbnailList = document.getElementById('thumbnailList');
            if (thumbnailList) {
                thumbnailList.innerHTML = `
                    <div class="empty-state" style="padding: 40px 20px; text-align: center; color: #999;">
                        <div class="loading" style="margin: 0 auto 20px;"></div>
                        <p style="font-size: 0.95em; line-height: 1.6;">
                            <strong>æ­£åœ¨å¤„ç†ä¸­...</strong><br>
                            æ¯ç”Ÿæˆä¸€å¼ å›¾ç‰‡å°†è‡ªåŠ¨ä¿å­˜ï¼Œå¹¶æ˜¾ç¤ºåœ¨è¿™é‡Œ
                        </p>
                    </div>
                `;
            }
            
            // æ›´æ–°é¢„è§ˆåŒºåŸŸæ˜¾ç¤ºå¤„ç†ä¸­çŠ¶æ€
            const previewContent = document.getElementById('previewContent');
            if (previewContent) {
                previewContent.innerHTML = `
                    <div class="empty-state" style="padding: 60px 40px; text-align: center; color: #999;">
                        <div class="loading" style="margin: 0 auto 30px; width: 50px; height: 50px;"></div>
                        <p style="font-size: 1.1em; margin-bottom: 10px; font-weight: bold; color: #666;">æ­£åœ¨å¤„ç†å›¾ç‰‡...</p>
                        <p style="color: #999;">å¤„ç†å®Œæˆåï¼Œç‚¹å‡»å·¦ä¾§ç¼©ç•¥å›¾å³å¯æŸ¥çœ‹å¯¹æ¯”æ•ˆæœ</p>
                    </div>
                `;
            }
            
            currentPreviewIndex = -1;
            
            // æ›´æ–°è‡ªåŠ¨ä¿å­˜æç¤º
            const autoSaveInfo = document.getElementById('autoSaveInfo');
            if (autoSaveInfo) {
                autoSaveInfo.textContent = 'ğŸ’¾ æ­£åœ¨å¤„ç†ä¸­ï¼Œæ¯ç”Ÿæˆä¸€å¼ å›¾ç‰‡å°†è‡ªåŠ¨ä¿å­˜åˆ°"ç›´æ¥æŠ•å…¥ä½¿ç”¨"æ–‡ä»¶å¤¹...';
                autoSaveInfo.style.background = '#fff3e0';
                autoSaveInfo.style.color = '#e65100';
                autoSaveInfo.style.borderLeftColor = '#ff9800';
            }

            // å‘é€å¤„ç†è¯·æ±‚
            console.log('=== å¼€å§‹å‘é€å¤„ç†è¯·æ±‚ ===');
            console.log('è¾“å…¥æ–‡ä»¶å¤¹:', folderPath);
            console.log('æç¤ºè¯:', promptText);
            
            // æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
            const statusMessage = document.getElementById('statusMessage');
            if (statusMessage) {
                statusMessage.innerHTML = '<div style="color: #5A9FD8; padding: 10px; background: #e3f2fd; border-radius: 5px; margin-top: 10px;">æ­£åœ¨å‘é€å¤„ç†è¯·æ±‚...</div>';
            }
            
            fetch('/api/process', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    input_folder: folderPath,
                    prompt: promptText
                })
            })
            .then(response => {
                console.log('æ”¶åˆ°å“åº”ï¼ŒçŠ¶æ€ç :', response.status);
                console.log('å“åº”å¤´:', response.headers);
                
                if (!response.ok) {
                    throw new Error(`HTTPé”™è¯¯! çŠ¶æ€ç : ${response.status}`);
                }
                
                return response.json();
            })
            .then(data => {
                console.log('å“åº”æ•°æ®:', data);
                if (statusMessage) {
                    statusMessage.innerHTML = '<div style="color: #4caf50; padding: 10px; background: #e8f5e9; border-radius: 5px; margin-top: 10px;">âœ“ å¤„ç†è¯·æ±‚å·²å‘é€ï¼Œæ­£åœ¨åˆå§‹åŒ–...</div>';
                }
                
                if (data.success) {
                    currentSessionId = data.session_id || '';
                    currentOutputFolder = data.output_folder || '';
                    console.log('å¼€å§‹çŠ¶æ€æ£€æŸ¥ï¼Œä¼šè¯ID:', currentSessionId);
                    startStatusCheck();
                } else {
                    if (statusMessage) {
                        statusMessage.innerHTML = `<div style="color: #f44336; padding: 10px; background: #ffebee; border-radius: 5px; margin-top: 10px;">âœ— é”™è¯¯: ${data.message}</div>`;
                    }
                    alert('é”™è¯¯: ' + data.message);
                    if (btn) {
                        btn.disabled = false;
                        btn.textContent = 'ğŸš€ å¼€å§‹å¤„ç†';
                    }
                }
            })
            .catch(error => {
                console.error('è¯·æ±‚å¤±è´¥:', error);
                console.error('é”™è¯¯è¯¦æƒ…:', error.stack);
                if (statusMessage) {
                    statusMessage.innerHTML = `<div style="color: #f44336; padding: 10px; background: #ffebee; border-radius: 5px; margin-top: 10px;">âœ— è¯·æ±‚å¤±è´¥: ${error.message}<br><small>è¯·æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°(F12)æŸ¥çœ‹è¯¦ç»†é”™è¯¯</small></div>`;
                }
                alert('è¯·æ±‚å¤±è´¥: ' + error.message + '\n\nè¯·æŒ‰F12æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°æŸ¥çœ‹è¯¦ç»†é”™è¯¯ä¿¡æ¯');
                if (btn) {
                    btn.disabled = false;
                    btn.textContent = 'ğŸš€ å¼€å§‹å¤„ç†';
                }
            });
            } catch (error) {
                console.error('startProcessing å‡½æ•°é”™è¯¯:', error);
                alert('å¯åŠ¨å¤„ç†æ—¶å‘ç”Ÿé”™è¯¯: ' + error.message + '\n\nè¯·æŒ‰F12æŸ¥çœ‹è¯¦ç»†é”™è¯¯ä¿¡æ¯');
                const btn = document.getElementById('processBtn');
                if (btn) {
                    btn.disabled = false;
                    btn.textContent = 'ğŸš€ å¼€å§‹å¤„ç†';
                }
            }
        }

        function switchMainTab(tab) {
            const aiPage = document.getElementById('aiPage');
            const resizePage = document.getElementById('resizePage');
            const tabAiBtn = document.getElementById('tabAiBtn');
            const tabResizeBtn = document.getElementById('tabResizeBtn');

            if (!aiPage || !resizePage || !tabAiBtn || !tabResizeBtn) return;

            if (tab === 'resize') {
                aiPage.style.display = 'none';
                resizePage.style.display = 'block';
                tabAiBtn.classList.remove('active');
                tabResizeBtn.classList.add('active');
            } else {
                resizePage.style.display = 'none';
                aiPage.style.display = 'block';
                tabResizeBtn.classList.remove('active');
                tabAiBtn.classList.add('active');
            }

            try {
                localStorage.setItem('mainTab', tab);
            } catch (e) {}
        }

        function startResize(mode) {
            const isCompressed = mode === 'compressed';
            const inputEl = document.getElementById(isCompressed ? 'compressedFolder' : 'originalIssueFolder');
            const btnEl = document.getElementById(isCompressed ? 'startCompressedBtn' : 'startOriginalBtn');
            const otherBtn = document.getElementById(isCompressed ? 'startOriginalBtn' : 'startCompressedBtn');
            const statusSection = document.getElementById('resizeStatusSection');
            const msgEl = document.getElementById('resizeStatusMessage');
            const outEl = document.getElementById('resizeOutputFolder');
            const modeEl = document.getElementById('resizeMode');
            const sharpenEnabledEl = document.getElementById('resizeSharpenEnabled');
            const sharpenStrengthEl = document.getElementById('resizeSharpenStrength');

            if (!inputEl) {
                alert('é”™è¯¯: æ‰¾ä¸åˆ°è¾“å…¥æ¡†å…ƒç´ ');
                return;
            }
            const folderPath = (inputEl.value || '').trim();
            if (!folderPath) {
                alert('è¯·è¾“å…¥å›¾ç‰‡æ–‡ä»¶å¤¹è·¯å¾„');
                return;
            }

            const sharpen = sharpenEnabledEl ? !!sharpenEnabledEl.checked : true;
            const strengthPct = sharpenStrengthEl ? parseFloat(sharpenStrengthEl.value) : 15;
            // å…è®¸åˆ° 150% -> 1.5
            const sharpenStrength = Number.isFinite(strengthPct) ? Math.max(0, Math.min(150, strengthPct)) / 100 : 0.15;

            if (btnEl) {
                btnEl.disabled = true;
                btnEl.textContent = 'â³ å¤„ç†ä¸­...';
            }
            if (otherBtn) otherBtn.disabled = true;

            if (statusSection) statusSection.style.display = 'block';
            if (msgEl) msgEl.innerHTML = '<div style="color:#5A9FD8; padding:10px; background:#e3f2fd; border-radius:8px; margin-top:10px;">æ­£åœ¨å‘é€ç¼©æ”¾è¯·æ±‚...</div>';
            if (modeEl) modeEl.textContent = isCompressed ? 'å‹ç¼©é—®é¢˜ï¼ˆ1026Ã—1539ï¼‰' : 'åŸå›¾é—®é¢˜ï¼ˆ2160Ã—3240ï¼‰';
            if (outEl) outEl.textContent = '-';

            fetch('/api/resize', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    input_folder: folderPath,
                    mode: mode,
                    sharpen: sharpen,
                    sharpen_strength: sharpenStrength
                })
            })
            .then(r => {
                if (!r.ok) throw new Error(`HTTP ${r.status}`);
                return r.json();
            })
            .then(data => {
                if (!data || !data.success) {
                    throw new Error((data && data.message) ? data.message : 'å¯åŠ¨å¤±è´¥');
                }
                if (outEl) outEl.textContent = data.output_folder || '-';
                if (msgEl) msgEl.innerHTML = '<div style="color:#4caf50; padding:10px; background:#e8f5e9; border-radius:8px; margin-top:10px;">âœ“ å·²å¼€å§‹å¤„ç†ï¼Œæ­£åœ¨ç¼©æ”¾...</div>';
                startResizeStatusCheck();
            })
            .catch(err => {
                console.error('startResize error:', err);
                if (msgEl) msgEl.innerHTML = `<div style="color:#f44336; padding:10px; background:#ffebee; border-radius:8px; margin-top:10px;">âœ— å¯åŠ¨å¤±è´¥: ${err.message}</div>`;
                if (btnEl) {
                    btnEl.disabled = false;
                    btnEl.textContent = isCompressed ? 'â–¶ å¼€å§‹ç¼©æ”¾ï¼ˆå‹ç¼©é—®é¢˜ï¼‰' : 'â–¶ å¼€å§‹ç¼©æ”¾ï¼ˆåŸå›¾é—®é¢˜ï¼‰';
                }
                if (otherBtn) otherBtn.disabled = false;
            });
        }

        function startResizeStatusCheck() {
            if (resizeCheckInterval) {
                clearInterval(resizeCheckInterval);
            }

            let isChecking = false;
            const doCheck = () => {
                if (isChecking) return;
                isChecking = true;

                fetch('/api/resize_status', {
                    method: 'GET',
                    cache: 'no-cache',
                    headers: { 'Cache-Control': 'no-cache' },
                    signal: AbortSignal.timeout(5000)
                })
                .then(r => {
                    if (!r.ok) throw new Error(`HTTP ${r.status}`);
                    return r.json();
                })
                .then(st => {
                    const statusSection = document.getElementById('resizeStatusSection');
                    const currentFile = document.getElementById('resizeCurrentFile');
                    const progress = document.getElementById('resizeProgress');
                    const fill = document.getElementById('resizeProgressFill');
                    const msgEl = document.getElementById('resizeStatusMessage');
                    const outEl = document.getElementById('resizeOutputFolder');
                    const modeEl = document.getElementById('resizeMode');

                    if (statusSection) statusSection.style.display = 'block';
                    if (outEl) outEl.textContent = st.output_folder || '-';
                    if (modeEl) {
                        if (st.mode === 'compressed') modeEl.textContent = 'å‹ç¼©é—®é¢˜ï¼ˆ1026Ã—1539ï¼‰';
                        else if (st.mode === 'original') modeEl.textContent = 'åŸå›¾é—®é¢˜ï¼ˆ2160Ã—3240ï¼‰';
                        else modeEl.textContent = '-';
                    }

                    if (currentFile) currentFile.textContent = st.current_file || '-';
                    if (progress) progress.textContent = `${st.processed_files || 0} / ${st.total_files || 0}`;
                    const pct = (st.total_files && st.total_files > 0)
                        ? Math.round((st.processed_files / st.total_files) * 100)
                        : 0;
                    if (fill) {
                        fill.style.width = `${pct}%`;
                        fill.textContent = `${pct}%`;
                    }

                    if (msgEl) {
                        if (st.is_processing) {
                            msgEl.innerHTML = '<div style="color:#5A9FD8; padding:10px; background:#e3f2fd; border-radius:8px; margin-top:10px;">æ­£åœ¨ç¼©æ”¾å¤„ç†ä¸­ï¼Œè¯·ç¨å€™...</div>';
                        } else {
                            const errCount = (st.errors && st.errors.length) ? st.errors.length : 0;
                            if (errCount > 0) {
                                msgEl.innerHTML = `<div style="color:#f57c00; padding:10px; background:#fff3e0; border-radius:8px; margin-top:10px;">å®Œæˆï¼Œä½†æœ‰ ${errCount} ä¸ªé”™è¯¯ï¼ˆå¯åœ¨æ§åˆ¶å°æŸ¥çœ‹ï¼‰ã€‚</div>`;
                            } else if ((st.processed_files || 0) > 0) {
                                msgEl.innerHTML = '<div style="color:#2e7d32; padding:10px; background:#e8f5e9; border-radius:8px; margin-top:10px;">âœ“ å…¨éƒ¨å®Œæˆï¼</div>';
                            } else {
                                msgEl.innerHTML = '<div style="color:#666; padding:10px; background:#f5f5f5; border-radius:8px; margin-top:10px;">ç­‰å¾…å¼€å§‹å¤„ç†</div>';
                            }
                        }
                    }

                    // æ¸²æŸ“ä»»åŠ¡æ—¥å¿—
                    renderResizeLogs(st);

                    // é¢„è§ˆï¼šæœ‰ output_folder æ—¶å°è¯•åˆ·æ–°ï¼ˆé¿å…é¢‘ç¹åˆ·æ–°ï¼šä»…åœ¨è¿›åº¦å˜åŒ–æˆ–é¦–æ¬¡ï¼‰
                    maybeAutoLoadResizePreview(st);

                    // ç»“æŸæ—¶æ¢å¤æŒ‰é’®
                    if (!st.is_processing) {
                        clearInterval(resizeCheckInterval);
                        resizeCheckInterval = null;
                        const startCompressedBtn = document.getElementById('startCompressedBtn');
                        const startOriginalBtn = document.getElementById('startOriginalBtn');
                        if (startCompressedBtn) {
                            startCompressedBtn.disabled = false;
                            startCompressedBtn.textContent = 'â–¶ å¼€å§‹ç¼©æ”¾ï¼ˆå‹ç¼©é—®é¢˜ï¼‰';
                        }
                        if (startOriginalBtn) {
                            startOriginalBtn.disabled = false;
                            startOriginalBtn.textContent = 'â–¶ å¼€å§‹ç¼©æ”¾ï¼ˆåŸå›¾é—®é¢˜ï¼‰';
                        }
                    }
                })
                .catch(err => {
                    console.error('resize status error:', err);
                })
                .finally(() => {
                    isChecking = false;
                });
            };

            doCheck();
            resizeCheckInterval = setInterval(doCheck, 2000);
        }

        let _lastResizeProcessed = -1;
        let _lastResizePreviewFolder = '';
        let _uiResizeLogCleared = false;

        function clearResizeLogUI() {
            _uiResizeLogCleared = true;
            const logEl = document.getElementById('resizeLogList');
            if (logEl) {
                logEl.innerHTML = '<div style="opacity:0.8;">ï¼ˆå·²æ¸…ç©ºæ˜¾ç¤ºï¼‰</div>';
                logEl.scrollTop = logEl.scrollHeight;
            }
        }

        function renderResizeLogs(st) {
            if (_uiResizeLogCleared) return;
            const logEl = document.getElementById('resizeLogList');
            if (!logEl) return;

            const logs = (st && Array.isArray(st.logs)) ? st.logs : [];
            const errors = (st && Array.isArray(st.errors)) ? st.errors : [];

            const lines = [];
            logs.forEach(l => lines.push(String(l)));
            // è¡¥å……é”™è¯¯ï¼ˆè‹¥åç«¯æœªå†™å…¥ logsï¼Œä¹Ÿèƒ½çœ‹åˆ°ï¼‰
            if (errors.length > 0) {
                lines.push('--- Errors ---');
                errors.slice(-50).forEach(e => lines.push(String(e)));
            }

            if (lines.length === 0) {
                logEl.innerHTML = '<div style="opacity:0.8;">æš‚æ— æ—¥å¿—</div>';
                return;
            }

            // ç®€å•è½¬ä¹‰
            const esc = (s) => String(s)
                .replaceAll('&', '&amp;')
                .replaceAll('<', '&lt;')
                .replaceAll('>', '&gt;');

            logEl.innerHTML = lines.slice(-300).map(l => `<div>${esc(l)}</div>`).join('');
            logEl.scrollTop = logEl.scrollHeight;
        }

        function maybeAutoLoadResizePreview(st) {
            const folder = (st && st.output_folder) ? st.output_folder : '';
            const processed = (st && typeof st.processed_files === 'number') ? st.processed_files : 0;
            if (!folder) return;

            const shouldReload = (folder !== _lastResizePreviewFolder) || (processed !== _lastResizeProcessed);
            if (!shouldReload) return;

            _lastResizePreviewFolder = folder;
            _lastResizeProcessed = processed;
            // é˜²æŠ–ä¸€ç‚¹ç‚¹ï¼Œé¿å…æ¯æ¬¡è½®è¯¢éƒ½æŠ–åŠ¨
            setTimeout(() => loadResizePreview(false), 200);
        }

        function loadResizePreview(force) {
            const outEl = document.getElementById('resizeOutputFolder');
            const metaEl = document.getElementById('resizePreviewMeta');
            const gridEl = document.getElementById('resizePreviewGrid');
            const folder = outEl ? (outEl.textContent || '').trim() : '';
            if (!gridEl) return;

            if (!folder || folder === '-') {
                if (metaEl) metaEl.textContent = 'è¾“å‡ºæ–‡ä»¶å¤¹æœªå°±ç»ª';
                gridEl.innerHTML = '<div class="empty-state" style="padding: 24px 10px;"><p style="margin:0;">æš‚æ— é¢„è§ˆ</p></div>';
                return;
            }

            if (metaEl) metaEl.textContent = 'æ­£åœ¨åŠ è½½é¢„è§ˆ...';

            fetch(`/api/resize_images?folder=${encodeURIComponent(folder)}`, { cache: 'no-cache' })
                .then(r => r.json().then(j => ({ ok: r.ok, status: r.status, body: j })))
                .then(({ ok, status, body }) => {
                    if (!ok) {
                        throw new Error((body && body.message) ? body.message : `HTTP ${status}`);
                    }
                    const images = body.images || [];
                    if (metaEl) metaEl.textContent = `å…± ${body.count || images.length} å¼ ï¼ˆç‚¹å‡»ç¼©ç•¥å›¾å¯æ”¾å¤§å¯¹æ¯”ï¼‰`;
                    if (!images.length) {
                        gridEl.innerHTML = '<div class="empty-state" style="padding: 24px 10px;"><p style="margin:0;">æš‚æ— é¢„è§ˆ</p></div>';
                        return;
                    }

                    gridEl.innerHTML = images.map((img) => {
                        const resizedUrl = `/api/image?path=${encodeURIComponent(img.resized)}`;
                        const originalUrl = img.original ? `/api/image?path=${encodeURIComponent(img.original)}` : '';
                        const name = img.name || '';
                        const nameEsc = name.replaceAll('"', '&quot;');
                        // ç”¨ data-xx ä¼ ç»™ç°æœ‰ zoom modalï¼ˆåŸå›¾ vs ç¼©æ”¾åï¼‰
                        return `
                            <div style="background:white; border-radius: 12px; padding: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                                <img src="${resizedUrl}" alt="${nameEsc}" style="width:100%; height: 180px; object-fit: contain; border-radius: 10px; cursor: zoom-in; background:#f6f7fb;"
                                     data-original-src="${originalUrl}"
                                     data-fixed-src="${resizedUrl}"
                                     onclick="openImageZoom(this.getAttribute('data-fixed-src'))"
                                     onerror="this.style.opacity=0.3;">
                                <div style="margin-top: 8px; font-size: 12px; color:#555; white-space: nowrap; overflow:hidden; text-overflow: ellipsis;" title="${nameEsc}">
                                    ${nameEsc}
                                </div>
                            </div>
                        `;
                    }).join('');
                })
                .catch(err => {
                    console.error('loadResizePreview error:', err);
                    if (metaEl) metaEl.textContent = `é¢„è§ˆåŠ è½½å¤±è´¥ï¼š${err.message}`;
                });
        }

        function startStatusCheck() {
            if (statusCheckInterval) {
                clearInterval(statusCheckInterval);
            }

            let consecutiveErrors = 0;
            const maxErrors = 10;  // æœ€å¤šå…è®¸10æ¬¡è¿ç»­é”™è¯¯
            let pollInterval = 20000;  // åˆå§‹è½®è¯¢é—´éš”20ç§’ï¼Œé¿å…ç½‘ç»œè¿æ¥è¶…æ—¶
            let isChecking = false;  // é˜²æ­¢å¹¶å‘è¯·æ±‚
            
            const doStatusCheck = () => {
                // é˜²æ­¢å¹¶å‘è¯·æ±‚
                if (isChecking) {
                    return;
                }
                
                isChecking = true;
                
                fetch('/api/status', {
                    method: 'GET',
                    cache: 'no-cache',
                    headers: {
                        'Cache-Control': 'no-cache'
                    },
                    signal: AbortSignal.timeout(30000)  // 30ç§’è¶…æ—¶ï¼Œç¡®ä¿20ç§’è½®è¯¢ä¸ä¼šè¶…æ—¶
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    return response.json();
                })
                .then(status => {
                    consecutiveErrors = 0;  // é‡ç½®é”™è¯¯è®¡æ•°
                    pollInterval = 20000;  // é‡ç½®è½®è¯¢é—´éš”ä¸º20ç§’
                    isChecking = false;
                    
                    updateStatus(status);
                    
                    // å®æ—¶æ›´æ–°å›¾ç‰‡åˆ—è¡¨
                    if (status.latest_processed && status.latest_processed.length > 0) {
                        updateImagesRealtime(status.latest_processed);
                    }
                    
                    if (!status.is_processing) {
                        // å¤„ç†å®Œæˆï¼Œåœæ­¢è½®è¯¢
                        if (statusCheckInterval) {
                            clearInterval(statusCheckInterval);
                            statusCheckInterval = null;
                        }
                        
                        const procBtn = document.getElementById('processBtn');
                        if (procBtn) {
                            procBtn.disabled = false;
                            procBtn.textContent = 'ğŸš€ å¼€å§‹å¤„ç†';
                        }
                        
                        if (status.processed_files > 0) {
                            // å¤„ç†å®Œæˆï¼ŒåŠ è½½æ‰€æœ‰å›¾ç‰‡
                            if (status.session_id) {
                                currentSessionId = status.session_id;
                            }
                            loadImages();
                        }
                    } else {
                        // å¦‚æœæ­£åœ¨å¤„ç†ï¼Œç»§ç»­ä¸‹ä¸€æ¬¡è½®è¯¢
                        setTimeout(doStatusCheck, pollInterval);
                    }
                })
                .catch(error => {
                    isChecking = false;
                    consecutiveErrors++;
                    
                    // åªè®°å½•éç½‘ç»œå˜æ›´é”™è¯¯ï¼ˆERR_NETWORK_CHANGED é€šå¸¸æ˜¯æš‚æ—¶çš„ï¼‰
                    if (!error.message.includes('Failed to fetch') && !error.name.includes('AbortError')) {
                        console.warn(`Status check error (${consecutiveErrors}/${maxErrors}):`, error);
                    }
                    
                    // å¦‚æœè¿ç»­é”™è¯¯ï¼Œé€æ¸å¢åŠ è½®è¯¢é—´éš”
                    if (consecutiveErrors > 3) {
                        pollInterval = Math.min(pollInterval * 1.2, 30000);  // æœ€å¤š30ç§’
                    }
                    
                    // å¦‚æœè¿ç»­é”™è¯¯å¤ªå¤šï¼Œåœæ­¢è½®è¯¢å¹¶æç¤ºç”¨æˆ·
                    if (consecutiveErrors >= maxErrors) {
                        console.error('è¿ç»­é”™è¯¯è¿‡å¤šï¼Œåœæ­¢çŠ¶æ€æ£€æŸ¥');
                        if (statusCheckInterval) {
                            clearInterval(statusCheckInterval);
                            statusCheckInterval = null;
                        }
                        
                        const statusMsg = document.getElementById('statusMessage');
                        if (statusMsg) {
                            statusMsg.innerHTML = '<div style="color: #f44336; padding: 10px; background: #ffebee; border-radius: 5px; margin-top: 10px;">âš ï¸ ç½‘ç»œè¿æ¥ä¸­æ–­ï¼Œè¯·åˆ·æ–°é¡µé¢æ£€æŸ¥å¤„ç†çŠ¶æ€</div>';
                        }
                        
                        const procBtn = document.getElementById('processBtn');
                        if (procBtn) {
                            procBtn.disabled = false;
                            procBtn.textContent = 'ğŸš€ å¼€å§‹å¤„ç†';
                        }
                    } else {
                        // ç»§ç»­é‡è¯•ï¼Œä½†ä½¿ç”¨æ›´é•¿çš„é—´éš”
                        setTimeout(doStatusCheck, pollInterval);
                    }
                });
            };
            
            // ç«‹å³æ‰§è¡Œç¬¬ä¸€æ¬¡æ£€æŸ¥
            doStatusCheck();
            
            // è®¾ç½®å®šæœŸæ£€æŸ¥ï¼ˆä½œä¸ºå¤‡ç”¨ï¼Œä½†é—´éš”æ›´é•¿ï¼Œ20ç§’è½®è¯¢ï¼‰
            statusCheckInterval = setInterval(doStatusCheck, pollInterval);
        }

        function updateStatus(status) {
            const currentFileEl = document.getElementById('currentFile');
            if (currentFileEl) {
                currentFileEl.textContent = status.current_file || '-';
            }
            
            const progress = status.total_files > 0 
                ? Math.round((status.processed_files / status.total_files) * 100)
                : 0;
            
            const progressEl = document.getElementById('progress');
            if (progressEl) {
                progressEl.textContent = `${status.processed_files} / ${status.total_files}`;
            }
            
            const progressFill = document.getElementById('progressFill');
            if (progressFill) {
                progressFill.style.width = progress + '%';
                progressFill.textContent = progress + '%';
            }

            const statusMessage = document.getElementById('statusMessage');
            if (!statusMessage) return;

            if (status.is_processing) {
                statusMessage.innerHTML = '<div class="loading"></div>æ­£åœ¨å¤„ç†ä¸­...';
            } else {
                // å¤„ç†å®Œæˆæˆ–å¤±è´¥
                if (status.total_files === 0 && status.errors.length > 0) {
                    // åˆå§‹åŒ–å¤±è´¥æˆ–æ²¡æœ‰æ‰¾åˆ°æ–‡ä»¶
                    let errorText = '<div class="error-message">';
                    errorText += '<strong>å¤„ç†å¤±è´¥ï¼</strong><br>';
                    status.errors.forEach(err => {
                        errorText += 'â€¢ ' + err + '<br>';
                    });
                    errorText += '</div>';
                    statusMessage.innerHTML = errorText;
                } else if (status.processed_files > 0) {
                    if (status.errors.length > 0) {
                        let errorText = '<div class="error-message">';
                        errorText += 'å¤„ç†å®Œæˆï¼Œä½†æœ‰ ' + status.errors.length + ' ä¸ªé”™è¯¯ï¼š<br>';
                        status.errors.slice(0, 5).forEach(err => {
                            errorText += 'â€¢ ' + err + '<br>';
                        });
                        if (status.errors.length > 5) {
                            errorText += '... è¿˜æœ‰ ' + (status.errors.length - 5) + ' ä¸ªé”™è¯¯';
                        }
                        errorText += '</div>';
                        statusMessage.innerHTML = errorText;
                    } else {
                        statusMessage.innerHTML = 
                            '<div class="success-message">âœ… å…¨éƒ¨å¤„ç†å®Œæˆï¼</div>';
                    }
                } else if (status.errors.length > 0) {
                    // å¤„ç†å¤±è´¥ä½†æ²¡æœ‰å¤„ç†ä»»ä½•æ–‡ä»¶
                    let errorText = '<div class="error-message">';
                    errorText += '<strong>å¤„ç†å¤±è´¥ï¼</strong><br>';
                    status.errors.forEach(err => {
                        errorText += 'â€¢ ' + err + '<br>';
                    });
                    errorText += '</div>';
                    statusMessage.innerHTML = errorText;
                } else {
                    // æœªå¤„ç†ä»»ä½•æ–‡ä»¶ï¼Œä¸”æ²¡æœ‰é”™è¯¯ï¼ˆå¯èƒ½æ˜¯åˆå§‹åŒ–æˆ–ç­‰å¾…çŠ¶æ€ï¼‰
                    statusMessage.innerHTML = '<div class="info-message">ç­‰å¾…å¼€å§‹å¤„ç†...</div>';
                }
            }
        }

        function loadImages() {
            if (!currentSessionId && !currentOutputFolder) return;

            let url = '/api/images?';
            if (currentSessionId) {
                url += `session_id=${encodeURIComponent(currentSessionId)}`;
            } else if (currentOutputFolder) {
                url += `folder=${encodeURIComponent(currentOutputFolder)}`;
            }

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    allImagesData = data.images;  // ä¿å­˜å›¾ç‰‡æ•°æ®
                    displayImages(data.images);
                })
                .catch(error => {
                    console.error('Load images error:', error);
                });
        }

        function displayImages(images) {
            const grid = document.getElementById('imagesGrid');
            const imagesSection = document.getElementById('imagesSection');
            const fileManagerContainer = document.getElementById('fileManagerContainer');
            const thumbnailList = document.getElementById('thumbnailList');
            
            console.log('Displaying images:', images.length);
            
            // ç¡®ä¿å›¾ç‰‡åŒºåŸŸæ˜¾ç¤º
            imagesSection.style.display = 'block';
            
            if (images.length === 0) {
                fileManagerContainer.style.display = 'none';
                grid.style.display = 'block';
                grid.innerHTML = `
                    <div class="empty-state">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                            <rect x="3" y="3" width="18" height="18" rx="2" stroke-width="2"/>
                            <path d="M9 9h6v6H9z" stroke-width="2"/>
                        </svg>
                        <p>æš‚æ— å¤„ç†ç»“æœ</p>
                    </div>
                `;
                return;
            }

            // æ˜¾ç¤ºæ–‡ä»¶ç®¡ç†å™¨
            fileManagerContainer.style.display = 'flex';
            grid.style.display = 'none';

            // ç”Ÿæˆç¼©ç•¥å›¾åˆ—è¡¨
            thumbnailList.innerHTML = images.map((img, index) => {
                const fixedUrl = `/api/image?path=${encodeURIComponent(img.fixed)}`;
                const isActive = index === currentPreviewIndex;

                return `
                    <div class="thumbnail-item ${isActive ? 'active' : ''}" 
                         onclick="showPreview(${index})"
                         data-index="${index}">
                        <img src="${fixedUrl}" alt="${img.name}" 
                             onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2260%22 height=%2260%22%3E%3Crect fill=%22%23ddd%22 width=%2260%22 height=%2260%22/%3E%3Ctext x=%2230%22 y=%2230%22 text-anchor=%22middle%22 fill=%22%23999%22%3Eå›¾ç‰‡%3C/text%3E%3C/svg%3E'">
                        <div class="thumbnail-info">
                            <div class="thumbnail-name" title="${img.name}">${img.name.replace('_clear.jpg', '')}</div>
                        </div>
                    </div>
                `;
            }).join('');

            // é»˜è®¤æ˜¾ç¤ºç¬¬ä¸€å¼ å›¾ç‰‡
            if (images.length > 0 && currentPreviewIndex === -1) {
                showPreview(0);
            }
            
            // æ›´æ–°è‡ªåŠ¨ä¿å­˜æç¤º
            const autoSaveInfo = document.getElementById('autoSaveInfo');
            if (autoSaveInfo && images.length > 0) {
                autoSaveInfo.textContent = `ğŸ’¾ å·²è‡ªåŠ¨ä¿å­˜ ${images.length} å¼ å›¾ç‰‡åˆ°"ç›´æ¥æŠ•å…¥ä½¿ç”¨"æ–‡ä»¶å¤¹`;
                autoSaveInfo.style.background = '#e8f5e9';
                autoSaveInfo.style.color = '#2e7d32';
                autoSaveInfo.style.borderLeftColor = '#4caf50';
            }
        }

        function showPreview(index) {
            if (!allImagesData || index < 0 || index >= allImagesData.length) return;

            currentPreviewIndex = index;
            const img = allImagesData[index];
            const previewContent = document.getElementById('previewContent');
            
            const originalUrl = img.original 
                ? `/api/image?path=${encodeURIComponent(img.original)}`
                : null;
            const fixedUrl = `/api/image?path=${encodeURIComponent(img.fixed)}`;

            // æ›´æ–°ç¼©ç•¥å›¾æ¿€æ´»çŠ¶æ€
            document.querySelectorAll('.thumbnail-item').forEach((item, i) => {
                if (i === index) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });

            // æ˜¾ç¤ºé¢„è§ˆï¼ˆä¸Šä¸‹å¸ƒå±€ï¼‰
            previewContent.innerHTML = `
                <div class="preview-comparison">
                    <div class="preview-image-wrapper">
                        <div class="preview-label" style="margin-bottom: 10px;">å¤„ç†å‰ï¼ˆåŸå›¾ï¼‰</div>
                        ${originalUrl 
                            ? `<img src="${originalUrl}" alt="åŸå›¾" onerror="this.parentElement.innerHTML='<div style=\\'padding:40px;text-align:center;color:#999\\'>åŸå›¾æœªæ‰¾åˆ°</div>'">`
                            : '<div style="padding:40px;text-align:center;color:#999;min-height:300px;display:flex;align-items:center;justify-content:center;">åŸå›¾æœªæ‰¾åˆ°</div>'
                        }
                    </div>
                    <div class="preview-image-wrapper">
                        <div class="preview-label" style="margin-bottom: 10px;">å¤„ç†åï¼ˆä¿®å¤åï¼‰</div>
                        <img src="${fixedUrl}" alt="ä¿®å¤å" class="zoomable-fixed"
                             title="åŒå‡»æ”¾å¤§é¢„è§ˆï¼ˆæ»šè½®ç¼©æ”¾ï¼‰"
                             data-original-src="${originalUrl || ''}"
                             data-fixed-src="${fixedUrl}"
                             onerror="this.parentElement.innerHTML='<div style=\\'padding:40px;text-align:center;color:#999\\'>å›¾ç‰‡åŠ è½½å¤±è´¥</div>'">
                    </div>
                </div>
                <div style="margin-top: 15px; text-align: center; color: #666;">
                    <strong>æ–‡ä»¶åï¼š</strong>${img.name}
                </div>
            `;
        }


        function updateImagesRealtime(newImages) {
            if (!newImages || newImages.length === 0) return;
            
            const thumbnailList = document.getElementById('thumbnailList');
            const fileManagerContainer = document.getElementById('fileManagerContainer');
            
            // ç¡®ä¿æ–‡ä»¶ç®¡ç†å™¨æ˜¾ç¤º
            fileManagerContainer.style.display = 'flex';
            document.getElementById('imagesGrid').style.display = 'none';
            
            // åˆå¹¶æ–°å›¾ç‰‡åˆ°ç°æœ‰æ•°æ®
            newImages.forEach(newImg => {
                // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
                const exists = allImagesData.some(img => img.name === newImg.name);
                if (!exists) {
                    allImagesData.push(newImg);
                }
            });
            
            // é‡æ–°ç”Ÿæˆç¼©ç•¥å›¾åˆ—è¡¨
            displayImages(allImagesData);
            
            // å¦‚æœå½“å‰æ²¡æœ‰é¢„è§ˆï¼Œè‡ªåŠ¨æ˜¾ç¤ºæœ€æ–°çš„ä¸€å¼ 
            if (currentPreviewIndex === -1 && allImagesData.length > 0) {
                showPreview(allImagesData.length - 1);
            }
        }

        // æ˜¾ç¤ºä»»åŠ¡æŠ¥å‘Š
        function showTaskReport() {
            fetch('/api/task_report')
                .then(response => response.json())
                .then(report => {
                    let reportHtml = `
                        <div style="max-width: 800px; margin: 0 auto; padding: 20px;">
                            <h2 style="color: #5A9FD8; margin-bottom: 20px;">ğŸ“Š ä»»åŠ¡è¯¦ç»†æŠ¥å‘Š</h2>
                            
                            <div style="background: white; border-radius: 10px; padding: 20px; margin-bottom: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                                <h3 style="color: #333; margin-top: 0;">çŠ¶æ€æ¦‚è§ˆ</h3>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                    <div>
                                        <strong>å¤„ç†çŠ¶æ€:</strong> 
                                        <span style="color: ${report.is_processing ? '#ff9800' : (report.errors.length > 0 ? '#f44336' : '#4caf50')};">
                                            ${report.status_summary}
                                        </span>
                                    </div>
                                    <div>
                                        <strong>è¿›åº¦:</strong> ${report.processed_files} / ${report.total_files} (${report.progress_percent}%)
                                    </div>
                                    <div>
                                        <strong>å½“å‰æ–‡ä»¶:</strong> ${report.current_file || '-'}
                                    </div>
                                    <div>
                                        <strong>é”™è¯¯æ•°é‡:</strong> 
                                        <span style="color: ${report.errors.length > 0 ? '#f44336' : '#4caf50'};">
                                            ${report.errors.length}
                                        </span>
                                    </div>
                                </div>
                            </div>
                            
                            ${report.input_folder ? `
                            <div style="background: white; border-radius: 10px; padding: 20px; margin-bottom: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                                <h3 style="color: #333; margin-top: 0;">è·¯å¾„ä¿¡æ¯</h3>
                                <div style="word-break: break-all;">
                                    <div style="margin-bottom: 10px;">
                                        <strong>è¾“å…¥æ–‡ä»¶å¤¹:</strong><br>
                                        <code style="background: #f5f5f5; padding: 5px 10px; border-radius: 5px;">${report.input_folder}</code>
                                    </div>
                                    ${report.temp_folder ? `
                                    <div>
                                        <strong>ä¸´æ—¶æ–‡ä»¶å¤¹:</strong><br>
                                        <code style="background: #f5f5f5; padding: 5px 10px; border-radius: 5px;">${report.temp_folder}</code>
                                    </div>
                                    ` : ''}
                                </div>
                            </div>
                            ` : ''}
                            
                            ${report.errors.length > 0 ? `
                            <div style="background: #ffebee; border-left: 4px solid #f44336; border-radius: 10px; padding: 20px; margin-bottom: 15px;">
                                <h3 style="color: #c62828; margin-top: 0;">âŒ é”™è¯¯åˆ—è¡¨ (${report.errors.length})</h3>
                                <div style="max-height: 400px; overflow-y: auto;">
                                    <ol style="margin: 0; padding-left: 20px;">
                                        ${report.errors.map((err, idx) => `
                                            <li style="margin-bottom: 10px; color: #333;">
                                                <code style="background: white; padding: 5px 10px; border-radius: 5px; display: block; margin-top: 5px;">${err}</code>
                                            </li>
                                        `).join('')}
                                    </ol>
                                </div>
                            </div>
                            ` : ''}
                            
                            <div style="text-align: center; margin-top: 20px;">
                                <button class="btn" onclick="document.getElementById('reportModal').style.display='none'" style="padding: 10px 30px;">
                                    å…³é—­
                                </button>
                            </div>
                        </div>
                    `;
                    
                    // åˆ›å»ºæˆ–æ›´æ–°æ¨¡æ€æ¡†
                    let modal = document.getElementById('reportModal');
                    if (!modal) {
                        modal = document.createElement('div');
                        modal.id = 'reportModal';
                        modal.style.cssText = 'display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5);';
                        modal.innerHTML = `
                            <div style="background-color: #fefefe; margin: 5% auto; padding: 0; border-radius: 15px; width: 90%; max-width: 900px; max-height: 90vh; overflow-y: auto; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
                                <div style="padding: 20px; border-bottom: 2px solid #7EBEFB; display: flex; justify-content: space-between; align-items: center;">
                                    <h2 style="margin: 0; color: #5A9FD8;">ä»»åŠ¡æŠ¥å‘Š</h2>
                                    <span onclick="document.getElementById('reportModal').style.display='none'" style="color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer;">&times;</span>
                                </div>
                                <div id="reportContent"></div>
                            </div>
                        `;
                        document.body.appendChild(modal);
                    }
                    
                    document.getElementById('reportContent').innerHTML = reportHtml;
                    modal.style.display = 'block';
                })
                .catch(error => {
                    console.error('è·å–ä»»åŠ¡æŠ¥å‘Šå¤±è´¥:', error);
                    alert('è·å–ä»»åŠ¡æŠ¥å‘Šå¤±è´¥: ' + error.message);
                });
        }

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­ï¼ˆä»»åŠ¡æŠ¥å‘Š + æ”¾å¤§é¢„è§ˆï¼‰
        window.addEventListener('click', function(event) {
            const reportModal = document.getElementById('reportModal');
            if (reportModal && event.target === reportModal) {
                reportModal.style.display = 'none';
            }
            
            const zoomModal = document.getElementById('imageZoomModal');
            if (zoomModal && event.target === zoomModal) {
                closeImageZoom();
            }
        });

        // æ”¾å¤§é¢„è§ˆï¼šç‚¹å‡»å›¾ç‰‡æ‰“å¼€ï¼Œæ»šè½®ç¼©æ”¾ï¼Œæ‹–æ‹½ç§»åŠ¨
        let _zoomScale = 1;
        let _zoomTx = 0;
        let _zoomTy = 0;
        let _zoomDragging = false;
        let _dragStartX = 0;
        let _dragStartY = 0;
        let _dragStartTx = 0;
        let _dragStartTy = 0;
        let _zoomImgW = 0;
        let _zoomImgH = 0;

        function applyZoomTransform() {
            const outer = document.getElementById('zoomLayerOuter');
            const inner = document.getElementById('zoomLayerInner');
            if (!outer || !inner) return;
            // æ˜ å°„å…³ç³»ï¼šscreen = img * scale + translate
            outer.style.transform = `translate(${_zoomTx}px, ${_zoomTy}px)`;
            inner.style.transform = `scale(${_zoomScale})`;
        }

        function openImageZoom(src) {
            const zoomModal = document.getElementById('imageZoomModal');
            const zoomCanvas = document.getElementById('zoomCanvas');
            const zoomImg = document.getElementById('zoomImage');
            const outer = document.getElementById('zoomLayerOuter');
            const inner = document.getElementById('zoomLayerInner');
            if (!zoomModal || !zoomCanvas || !zoomImg || !outer || !inner) return;

            zoomImg.src = src || '';

            zoomModal.style.display = 'block';
            zoomModal.setAttribute('aria-hidden', 'false');

            _zoomScale = 1;
            _zoomTx = 0;
            _zoomTy = 0;
            _zoomDragging = false;
            zoomCanvas.classList.remove('dragging');

            // ç­‰å›¾ç‰‡åŠ è½½åå±…ä¸­
            zoomImg.onload = () => {
                const rect = zoomCanvas.getBoundingClientRect();
                const iw = zoomImg.naturalWidth || rect.width;
                const ih = zoomImg.naturalHeight || rect.height;
                _zoomImgW = iw;
                _zoomImgH = ih;

                // è®¾ç½® outer/inner çš„å®é™…å°ºå¯¸
                outer.style.width = `${iw}px`;
                outer.style.height = `${ih}px`;
                inner.style.width = `${iw}px`;
                inner.style.height = `${ih}px`;

                // è®©å›¾ç‰‡é»˜è®¤å°½é‡é€‚é…ç”»å¸ƒï¼ˆä¸æ”¾å¤§è¶…è¿‡1ï¼‰
                const s = Math.min(rect.width / iw, rect.height / ih, 1);
                _zoomScale = s;
                _zoomTx = (rect.width - iw * _zoomScale) / 2;
                _zoomTy = (rect.height - ih * _zoomScale) / 2;
                applyZoomTransform();
            };

            applyZoomTransform();
        }

        function closeImageZoom() {
            const zoomModal = document.getElementById('imageZoomModal');
            const zoomCanvas = document.getElementById('zoomCanvas');
            const zoomImg = document.getElementById('zoomImage');
            if (zoomModal) {
                zoomModal.style.display = 'none';
                zoomModal.setAttribute('aria-hidden', 'true');
            }
            if (zoomImg) zoomImg.src = '';
            if (zoomCanvas) {
                zoomCanvas.classList.remove('dragging');
            }
            _zoomDragging = false;
        }

        // äº‹ä»¶å§”æ‰˜ï¼šç‚¹å‡»å›¾ç‰‡æ‰“å¼€é¢„è§ˆ
        document.addEventListener('click', function(e) {
            const t = e.target;
            if (t && t.tagName === 'IMG' && t.classList.contains('zoomable-fixed')) {
                const fixedSrc = t.getAttribute('data-fixed-src') || t.src || '';
                openImageZoom(fixedSrc);
            }
        });

        // å…³é—­æŒ‰é’®
        document.addEventListener('click', function(e) {
            const t = e.target;
            if (t && t.id === 'zoomClose') {
                closeImageZoom();
            }
        });

        // ESC å…³é—­
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const zoomModal = document.getElementById('imageZoomModal');
                if (zoomModal && zoomModal.style.display === 'block') {
                    closeImageZoom();
                }
            }
        });

        // æ»šè½®ç¼©æ”¾ï¼ˆä»¥é¼ æ ‡ä½ç½®ä¸ºç¼©æ”¾ä¸­å¿ƒï¼‰
        const _zoomWheelHandler = function(e) {
            const zoomModal = document.getElementById('imageZoomModal');
            if (!zoomModal || zoomModal.style.display !== 'block') return;

            const zoomCanvas = document.getElementById('zoomCanvas');
            if (!zoomCanvas) return;
            // åªåœ¨ç”»å¸ƒåŒºåŸŸå†…æ»šè½®æ‰è§¦å‘ç¼©æ”¾ï¼ˆé¿å…å½±å“æ‹‰æ†åŒºåŸŸï¼‰
            if (!zoomCanvas.contains(e.target)) return;

            e.preventDefault();

            const rect = zoomCanvas.getBoundingClientRect();
            const cx = e.clientX - rect.left;
            const cy = e.clientY - rect.top;

            const prevScale = _zoomScale;
            const direction = e.deltaY > 0 ? -1 : 1; // deltaY>0 å‘ä¸‹æ»š => ç¼©å°
            const factor = 1.12;
            let nextScale = direction > 0 ? prevScale * factor : prevScale / factor;
            nextScale = Math.max(0.1, Math.min(10, nextScale));

            // å°†é¼ æ ‡ç‚¹å›ºå®šåœ¨åŒä¸€â€œå›¾åƒåæ ‡â€
            const wx = (cx - _zoomTx) / prevScale;
            const wy = (cy - _zoomTy) / prevScale;
            _zoomScale = nextScale;
            _zoomTx = cx - wx * _zoomScale;
            _zoomTy = cy - wy * _zoomScale;

            applyZoomTransform();
        };
        document.addEventListener('wheel', _zoomWheelHandler, { passive: false });

        // æ‹–æ‹½å¹³ç§»
        document.addEventListener('mousedown', function(e) {
            const zoomModal = document.getElementById('imageZoomModal');
            if (!zoomModal || zoomModal.style.display !== 'block') return;

            const zoomCanvas = document.getElementById('zoomCanvas');
            if (!zoomCanvas) return;

            // åªå…è®¸åœ¨ç”»å¸ƒåŒºåŸŸæŒ‰ä¸‹å¼€å§‹æ‹–æ‹½ï¼ˆé¿å…ç‚¹åˆ°å…³é—­æŒ‰é’®/æç¤ºæ¡ä¹Ÿè§¦å‘ï¼‰
            if (!zoomCanvas.contains(e.target)) return;

            _zoomDragging = true;
            _dragStartX = e.clientX;
            _dragStartY = e.clientY;
            _dragStartTx = _zoomTx;
            _dragStartTy = _zoomTy;
            zoomCanvas.classList.add('dragging');
        });

        document.addEventListener('mousemove', function(e) {
            if (!_zoomDragging) return;
            const dx = e.clientX - _dragStartX;
            const dy = e.clientY - _dragStartY;
            _zoomTx = _dragStartTx + dx;
            _zoomTy = _dragStartTy + dy;
            applyZoomTransform();
        });

        document.addEventListener('mouseup', function() {
            if (!_zoomDragging) return;
            _zoomDragging = false;
            const zoomCanvas = document.getElementById('zoomCanvas');
            if (zoomCanvas) zoomCanvas.classList.remove('dragging');
        });

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥æ˜¯å¦æœ‰æ­£åœ¨è¿›è¡Œçš„ä»»åŠ¡
        window.onload = function() {
            // æ¢å¤ä¸Šæ¬¡Tab
            try {
                const lastTab = localStorage.getItem('mainTab') || 'ai';
                switchMainTab(lastTab);
            } catch (e) {}

            fetch('/api/status')
                .then(response => response.json())
                .then(status => {
                    if (status.is_processing) {
                        document.getElementById('statusSection').style.display = 'block';
                        const procBtn2 = document.getElementById('processBtn');
                        if (procBtn2) {
                            procBtn2.disabled = true;
                            procBtn2.textContent = 'â³ å¤„ç†ä¸­...';
                        }
                        if (status.session_id) {
                            currentSessionId = status.session_id;
                        }
                        startStatusCheck();
                    }
                });

            // å¦‚æœå°ºå¯¸é€šé“æ­£åœ¨è¿›è¡Œï¼Œä¹Ÿæ¢å¤çŠ¶æ€è½®è¯¢
            fetch('/api/resize_status')
                .then(r => r.json())
                .then(st => {
                    if (st && st.is_processing) {
                        const statusSection = document.getElementById('resizeStatusSection');
                        if (statusSection) statusSection.style.display = 'block';
                        startResizeStatusCheck();
                    } else if (st && st.output_folder) {
                        // ä¸åœ¨å¤„ç†ä¸­ä¹Ÿå°è¯•åŠ è½½ä¸€æ¬¡é¢„è§ˆ/æ—¥å¿—
                        renderResizeLogs(st);
                        setTimeout(() => loadResizePreview(false), 200);
                    }
                })
                .catch(() => {});
        };

        // å°ºå¯¸é€šé“ï¼šé”åŒ–å¼ºåº¦æ˜¾ç¤º
        (function initResizeSharpenUI() {
            const el = document.getElementById('resizeSharpenStrength');
            const valEl = document.getElementById('resizeSharpenStrengthValue');
            if (!el || !valEl) return;
            const update = () => {
                valEl.textContent = `${el.value}%`;
            };
            el.addEventListener('input', update);
            update();
        })();
    </script>
</body>
</html>

