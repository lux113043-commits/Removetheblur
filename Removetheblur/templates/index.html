<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å›¾ç‰‡èƒŒæ™¯ä¿®å¤å·¥å…·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #7EBEFB 0%, #5A9FD8 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #7EBEFB 0%, #5A9FD8 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .content {
            padding: 40px;
        }

        .input-section {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
            font-size: 1.1em;
        }

        .form-group input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #7EBEFB;
        }

        .btn {
            background: linear-gradient(135deg, #7EBEFB 0%, #5A9FD8 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.1em;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            font-weight: bold;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(126, 190, 251, 0.4);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .status-section {
            background: #fff;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            border-left: 4px solid #7EBEFB;
        }

        .status-item {
            margin: 10px 0;
            font-size: 1em;
        }

        .status-item strong {
            color: #5A9FD8;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e9ecef;
            border-radius: 15px;
            overflow: hidden;
            margin: 15px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #7EBEFB 0%, #5A9FD8 100%);
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .images-section {
            margin-top: 30px;
        }

        .file-manager-container {
            display: flex;
            gap: 20px;
            margin-top: 20px;
            height: 70vh;
            min-height: 600px;
        }

        .thumbnail-panel {
            width: 300px;
            background: #f8f9fa;
            border-radius: 15px;
            padding: 15px;
            overflow-y: auto;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .thumbnail-panel h3 {
            margin-bottom: 15px;
            color: #333;
            font-size: 1.1em;
            padding-bottom: 10px;
            border-bottom: 2px solid #7EBEFB;
        }

        .thumbnail-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .thumbnail-item {
            background: white;
            border-radius: 8px;
            padding: 8px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .thumbnail-item:hover {
            background: #E6F4FD;
            border-color: #7EBEFB;
            transform: translateX(5px);
        }

        .thumbnail-item.active {
            background: #E6F4FD;
            border-color: #7EBEFB;
            box-shadow: 0 2px 8px rgba(126, 190, 251, 0.3);
        }

        .thumbnail-item img {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 6px;
        }

        .thumbnail-item .thumbnail-info {
            flex: 1;
            min-width: 0;
        }

        .thumbnail-item .thumbnail-name {
            font-size: 0.9em;
            color: #333;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 4px;
        }

        .thumbnail-item .thumbnail-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .preview-panel {
            flex: 1;
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            overflow-y: auto;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
        }

        .preview-panel h3 {
            margin-bottom: 15px;
            color: #333;
            font-size: 1.1em;
            padding-bottom: 10px;
            border-bottom: 2px solid #7EBEFB;
        }

        .preview-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 400px;
        }

        .preview-image-container {
            width: 100%;
            max-width: 1200px;
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .preview-image-container img {
            width: 100%;
            height: auto;
            border-radius: 8px;
            display: block;
        }

        .preview-comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            width: 100%;
        }

        .preview-image-wrapper {
            background: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            width: 100%;
        }

        .preview-image-wrapper img {
            width: 100%;
            height: auto;
            border-radius: 8px;
            max-height: 600px;
            object-fit: contain;
        }

        .preview-label {
            text-align: center;
            margin-top: 10px;
            font-weight: bold;
            color: #5A9FD8;
        }

        .images-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(600px, 1fr));
            gap: 30px;
            margin-top: 20px;
        }

        .image-card {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: relative;
            transition: all 0.3s;
        }

        .image-card.selected {
            background: #E6F4FD;
            border: 2px solid #7EBEFB;
            box-shadow: 0 4px 20px rgba(126, 190, 251, 0.3);
        }

        .image-card h3 {
            margin-bottom: 15px;
            color: #333;
            font-size: 1.2em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .image-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .comparison-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
        }

        .image-wrapper {
            position: relative;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .image-wrapper img {
            width: 100%;
            height: auto;
            display: block;
        }

        .image-label {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 8px;
            text-align: center;
            font-size: 0.9em;
        }

        .error-message {
            background: #fee;
            color: #c33;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid #c33;
        }

        .success-message {
            background: #efe;
            color: #3c3;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid #3c3;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #7EBEFB;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state svg {
            width: 100px;
            height: 100px;
            margin-bottom: 20px;
            opacity: 0.5;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ–¼ï¸ å›¾ç‰‡èƒŒæ™¯ä¿®å¤å·¥å…·</h1>
            <p>ä½¿ç”¨AIè‡ªåŠ¨ä¿®å¤å›¾ç‰‡èƒŒæ™¯ï¼Œè¾“å‡º1024Ã—1536æ¸…æ™°å›¾ç‰‡</p>
        </div>

        <div class="content">
            <div class="input-section">
                <div class="form-group">
                    <label for="inputFolder">ğŸ“ å›¾ç‰‡æ–‡ä»¶å¤¹è·¯å¾„ï¼š</label>
                    <input type="text" id="inputFolder" placeholder="ä¾‹å¦‚: D:\Photos\input_images" />
                </div>
                <button class="btn" id="processBtn" onclick="startProcessing()">
                    ğŸš€ å¼€å§‹å¤„ç†
                </button>
            </div>

            <div class="status-section" id="statusSection" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h2 style="margin: 0;">å¤„ç†çŠ¶æ€</h2>
                    <button class="btn" onclick="showTaskReport()" id="taskReportBtn" style="padding: 8px 20px; font-size: 0.9em; background: linear-gradient(135deg, #5A9FD8 0%, #7EBEFB 100%);">
                        ğŸ“Š ä»»åŠ¡æŠ¥å‘Š
                    </button>
                </div>
                <div class="status-item">
                    <strong>å½“å‰æ–‡ä»¶ï¼š</strong> <span id="currentFile">-</span>
                </div>
                <div class="status-item">
                    <strong>è¿›åº¦ï¼š</strong> <span id="progress">0 / 0</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 0%">0%</div>
                </div>
                <div id="statusMessage"></div>
            </div>

            <div class="images-section" id="imagesSection" style="display: block;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;">
                    <h2 style="margin: 0;">å¤„ç†ç»“æœå¯¹æ¯”</h2>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn" onclick="selectAll()" id="selectAllBtn" style="padding: 10px 20px; font-size: 0.9em;" disabled>âœ“ å…¨é€‰</button>
                        <button class="btn" onclick="deselectAll()" id="deselectAllBtn" style="padding: 10px 20px; font-size: 0.9em;" disabled>âœ— å–æ¶ˆå…¨é€‰</button>
                        <button class="btn" onclick="saveSelected('ready')" id="saveReadyBtn" style="padding: 10px 25px; font-size: 0.95em; background: linear-gradient(135deg, #28a745 0%, #20c997 100%);" disabled>
                            âœ… ä¿å­˜åˆ°"ç›´æ¥æŠ•å…¥ä½¿ç”¨"
                        </button>
                        <button class="btn" onclick="saveSelected('reprocess')" id="saveReprocessBtn" style="padding: 10px 25px; font-size: 0.95em; background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);" disabled>
                            ğŸ”„ ä¿å­˜åˆ°"éœ€è¦å†æ¬¡å¤„ç†"
                        </button>
                    </div>
                </div>
                <div id="selectedCount" style="margin-bottom: 15px; color: #5A9FD8; font-weight: bold; padding: 10px; background: #E6F4FD; border-radius: 8px;">
                    ç­‰å¾…å¤„ç†å®Œæˆ...
                </div>
                
                <!-- æ–‡ä»¶ç®¡ç†å’Œé¢„è§ˆåŒºåŸŸ -->
                <div class="file-manager-container" id="fileManagerContainer" style="display: flex;">
                    <div class="thumbnail-panel">
                        <h3>ğŸ“ å›¾ç‰‡åˆ—è¡¨</h3>
                        <div class="thumbnail-list" id="thumbnailList">
                            <div class="empty-state" style="padding: 40px 20px; text-align: center; color: #999;">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" style="width: 60px; height: 60px; margin: 0 auto 15px; opacity: 0.3;">
                                    <rect x="3" y="3" width="18" height="18" rx="2" stroke-width="2"/>
                                    <path d="M9 9h6v6H9z" stroke-width="2"/>
                                </svg>
                                <p style="font-size: 0.95em; line-height: 1.6;">
                                    <strong>ç­‰å¾…å›¾ç‰‡å¤„ç†</strong><br>
                                    å¤„ç†å®Œæˆåï¼Œè¿™é‡Œå°†æ˜¾ç¤ºæ‰€æœ‰å›¾ç‰‡çš„ç¼©ç•¥å›¾åˆ—è¡¨
                                </p>
                            </div>
                        </div>
                    </div>
                    <div class="preview-panel">
                        <h3>ğŸ–¼ï¸ å›¾ç‰‡é¢„è§ˆ</h3>
                        <div class="preview-content" id="previewContent">
                            <div class="empty-state" style="padding: 60px 40px; text-align: center; color: #999;">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" style="width: 100px; height: 100px; margin: 0 auto 20px; opacity: 0.3;">
                                    <rect x="3" y="3" width="18" height="18" rx="2" stroke-width="2"/>
                                    <circle cx="8.5" cy="8.5" r="1.5" stroke-width="2"/>
                                    <path d="M21 15l-5-5L5 21" stroke-width="2"/>
                                </svg>
                                <p style="font-size: 1.1em; margin-bottom: 15px; font-weight: bold; color: #666;">åŠŸèƒ½è¯´æ˜</p>
                                <div style="text-align: left; color: #666; line-height: 2; max-width: 500px; margin: 0 auto;">
                                    <p>ğŸ“‹ <strong>å·¦ä¾§ï¼š</strong>å›¾ç‰‡ç¼©ç•¥å›¾åˆ—è¡¨ï¼Œæ˜¾ç¤ºæ‰€æœ‰å¤„ç†åçš„å›¾ç‰‡</p>
                                    <p>ğŸ–¼ï¸ <strong>å³ä¾§ï¼š</strong>ç‚¹å‡»ç¼©ç•¥å›¾åï¼Œè¿™é‡Œæ˜¾ç¤ºåŸå›¾ä¸ä¿®å¤åçš„å¯¹æ¯”å¤§å›¾</p>
                                    <p>âœ“ <strong>é€‰æ‹©ï¼š</strong>é€šè¿‡ç¼©ç•¥å›¾å‰çš„å¤é€‰æ¡†é€‰æ‹©è¦ä¿å­˜çš„å›¾ç‰‡</p>
                                    <p>ğŸ’¾ <strong>ä¿å­˜ï¼š</strong>ç‚¹å‡»"ä¿å­˜é€‰ä¸­å›¾ç‰‡"æŒ‰é’®ä¿å­˜åˆ°è¾“å‡ºæ–‡ä»¶å¤¹</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- åŸæ¥çš„ç½‘æ ¼è§†å›¾ï¼ˆå¤‡ç”¨ï¼‰ -->
                <div class="images-grid" id="imagesGrid" style="display: none;">
                    <div class="empty-state">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" style="width: 80px; height: 80px; margin-bottom: 20px; opacity: 0.3;">
                            <rect x="3" y="3" width="18" height="18" rx="2" stroke-width="2"/>
                            <path d="M9 9h6v6H9z" stroke-width="2"/>
                        </svg>
                        <p style="font-size: 1.1em; margin-bottom: 10px; font-weight: bold;">ğŸ“‹ åŠŸèƒ½è¯´æ˜</p>
                        <div style="text-align: left; color: #666; line-height: 1.8; max-width: 600px; margin: 0 auto;">
                            <p>1. è¾“å…¥å›¾ç‰‡æ–‡ä»¶å¤¹è·¯å¾„ï¼Œç‚¹å‡»"å¼€å§‹å¤„ç†"</p>
                            <p>2. å¤„ç†å®Œæˆåï¼Œå·¦ä¾§æ˜¾ç¤ºç¼©ç•¥å›¾åˆ—è¡¨ï¼Œå³ä¾§æ˜¾ç¤ºå¤§å›¾é¢„è§ˆ</p>
                            <p>3. å‹¾é€‰æ»¡æ„çš„å›¾ç‰‡ï¼Œç„¶åç‚¹å‡»"ä¿å­˜é€‰ä¸­å›¾ç‰‡"æŒ‰é’®</p>
                            <p>4. å›¾ç‰‡å°†ä¿å­˜åˆ°ï¼š<code style="background: #f0f0f0; padding: 2px 6px; border-radius: 4px;">è¾“å…¥æ–‡ä»¶å¤¹/fixed_images/</code></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let statusCheckInterval = null;
        let imagesCheckInterval = null;
        let currentSessionId = '';
        let currentOutputFolder = '';
        let selectedImages = new Set();
        let currentPreviewIndex = -1;
        let allImagesData = [];  // å­˜å‚¨æ‰€æœ‰å›¾ç‰‡æ•°æ®

        function startProcessing() {
            try {
                const inputFolder = document.getElementById('inputFolder');
                if (!inputFolder) {
                    alert('é”™è¯¯: æ‰¾ä¸åˆ°è¾“å…¥æ¡†å…ƒç´ ');
                    console.error('æ‰¾ä¸åˆ° inputFolder å…ƒç´ ');
                    return;
                }
                
                const folderPath = inputFolder.value.trim();
                
                if (!folderPath) {
                    alert('è¯·è¾“å…¥å›¾ç‰‡æ–‡ä»¶å¤¹è·¯å¾„');
                    return;
                }

                const btn = document.getElementById('processBtn');
                if (!btn) {
                    alert('é”™è¯¯: æ‰¾ä¸åˆ°å¤„ç†æŒ‰é’®');
                    console.error('æ‰¾ä¸åˆ° processBtn å…ƒç´ ');
                    return;
                }
                
                btn.disabled = true;
                btn.textContent = 'â³ å¤„ç†ä¸­...';

            // æ˜¾ç¤ºçŠ¶æ€åŒºåŸŸ
            const statusSection = document.getElementById('statusSection');
            const imagesSection = document.getElementById('imagesSection');
            const fileManagerContainer = document.getElementById('fileManagerContainer');
            const imagesGrid = document.getElementById('imagesGrid');
            
            if (statusSection) statusSection.style.display = 'block';
            if (imagesSection) imagesSection.style.display = 'block';
            if (fileManagerContainer) fileManagerContainer.style.display = 'flex';
            if (imagesGrid) imagesGrid.style.display = 'none';
            
            // æ›´æ–°ç¼©ç•¥å›¾åˆ—è¡¨æ˜¾ç¤ºå¤„ç†ä¸­çŠ¶æ€
            const thumbnailList = document.getElementById('thumbnailList');
            if (thumbnailList) {
                thumbnailList.innerHTML = `
                    <div class="empty-state" style="padding: 40px 20px; text-align: center; color: #999;">
                        <div class="loading" style="margin: 0 auto 20px;"></div>
                        <p style="font-size: 0.95em; line-height: 1.6;">
                            <strong>æ­£åœ¨å¤„ç†ä¸­...</strong><br>
                            è¯·ç¨å€™ï¼Œå¤„ç†å®Œæˆåå›¾ç‰‡å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ
                        </p>
                    </div>
                `;
            }
            
            // æ›´æ–°é¢„è§ˆåŒºåŸŸæ˜¾ç¤ºå¤„ç†ä¸­çŠ¶æ€
            const previewContent = document.getElementById('previewContent');
            if (previewContent) {
                previewContent.innerHTML = `
                    <div class="empty-state" style="padding: 60px 40px; text-align: center; color: #999;">
                        <div class="loading" style="margin: 0 auto 30px; width: 50px; height: 50px;"></div>
                        <p style="font-size: 1.1em; margin-bottom: 10px; font-weight: bold; color: #666;">æ­£åœ¨å¤„ç†å›¾ç‰‡...</p>
                        <p style="color: #999;">å¤„ç†å®Œæˆåï¼Œç‚¹å‡»å·¦ä¾§ç¼©ç•¥å›¾å³å¯æŸ¥çœ‹å¯¹æ¯”æ•ˆæœ</p>
                    </div>
                `;
            }
            
            currentPreviewIndex = -1;
            const selectedCount = document.getElementById('selectedCount');
            if (selectedCount) {
                selectedCount.textContent = 'å¤„ç†ä¸­ï¼Œè¯·ç­‰å¾…...';
                selectedCount.style.background = '#fff3e0';
                selectedCount.style.color = '#e65100';
            }
            
            // ç¦ç”¨æŒ‰é’®
            const selectAllBtn = document.getElementById('selectAllBtn');
            const deselectAllBtn = document.getElementById('deselectAllBtn');
            const saveReadyBtn = document.getElementById('saveReadyBtn');
            const saveReprocessBtn = document.getElementById('saveReprocessBtn');
            
            if (selectAllBtn) selectAllBtn.disabled = true;
            if (deselectAllBtn) deselectAllBtn.disabled = true;
            if (saveReadyBtn) saveReadyBtn.disabled = true;
            if (saveReprocessBtn) saveReprocessBtn.disabled = true;

            // å‘é€å¤„ç†è¯·æ±‚
            console.log('=== å¼€å§‹å‘é€å¤„ç†è¯·æ±‚ ===');
            console.log('è¾“å…¥æ–‡ä»¶å¤¹:', folderPath);
            
            // æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
            const statusMessage = document.getElementById('statusMessage');
            if (statusMessage) {
                statusMessage.innerHTML = '<div style="color: #5A9FD8; padding: 10px; background: #e3f2fd; border-radius: 5px; margin-top: 10px;">æ­£åœ¨å‘é€å¤„ç†è¯·æ±‚...</div>';
            }
            
            fetch('/api/process', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    input_folder: folderPath
                })
            })
            .then(response => {
                console.log('æ”¶åˆ°å“åº”ï¼ŒçŠ¶æ€ç :', response.status);
                console.log('å“åº”å¤´:', response.headers);
                
                if (!response.ok) {
                    throw new Error(`HTTPé”™è¯¯! çŠ¶æ€ç : ${response.status}`);
                }
                
                return response.json();
            })
            .then(data => {
                console.log('å“åº”æ•°æ®:', data);
                if (statusMessage) {
                    statusMessage.innerHTML = '<div style="color: #4caf50; padding: 10px; background: #e8f5e9; border-radius: 5px; margin-top: 10px;">âœ“ å¤„ç†è¯·æ±‚å·²å‘é€ï¼Œæ­£åœ¨åˆå§‹åŒ–...</div>';
                }
                
                if (data.success) {
                    currentSessionId = data.session_id || '';
                    currentOutputFolder = data.output_folder || '';
                    selectedImages.clear();
                    console.log('å¼€å§‹çŠ¶æ€æ£€æŸ¥ï¼Œä¼šè¯ID:', currentSessionId);
                    startStatusCheck();
                } else {
                    if (statusMessage) {
                        statusMessage.innerHTML = `<div style="color: #f44336; padding: 10px; background: #ffebee; border-radius: 5px; margin-top: 10px;">âœ— é”™è¯¯: ${data.message}</div>`;
                    }
                    alert('é”™è¯¯: ' + data.message);
                    if (btn) {
                        btn.disabled = false;
                        btn.textContent = 'ğŸš€ å¼€å§‹å¤„ç†';
                    }
                }
            })
            .catch(error => {
                console.error('è¯·æ±‚å¤±è´¥:', error);
                console.error('é”™è¯¯è¯¦æƒ…:', error.stack);
                if (statusMessage) {
                    statusMessage.innerHTML = `<div style="color: #f44336; padding: 10px; background: #ffebee; border-radius: 5px; margin-top: 10px;">âœ— è¯·æ±‚å¤±è´¥: ${error.message}<br><small>è¯·æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°(F12)æŸ¥çœ‹è¯¦ç»†é”™è¯¯</small></div>`;
                }
                alert('è¯·æ±‚å¤±è´¥: ' + error.message + '\n\nè¯·æŒ‰F12æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°æŸ¥çœ‹è¯¦ç»†é”™è¯¯ä¿¡æ¯');
                if (btn) {
                    btn.disabled = false;
                    btn.textContent = 'ğŸš€ å¼€å§‹å¤„ç†';
                }
            });
            } catch (error) {
                console.error('startProcessing å‡½æ•°é”™è¯¯:', error);
                alert('å¯åŠ¨å¤„ç†æ—¶å‘ç”Ÿé”™è¯¯: ' + error.message + '\n\nè¯·æŒ‰F12æŸ¥çœ‹è¯¦ç»†é”™è¯¯ä¿¡æ¯');
                const btn = document.getElementById('processBtn');
                if (btn) {
                    btn.disabled = false;
                    btn.textContent = 'ğŸš€ å¼€å§‹å¤„ç†';
                }
            }
        }

        function startStatusCheck() {
            if (statusCheckInterval) {
                clearInterval(statusCheckInterval);
            }

            let consecutiveErrors = 0;
            const maxErrors = 10;  // æœ€å¤šå…è®¸10æ¬¡è¿ç»­é”™è¯¯
            let pollInterval = 3000;  // åˆå§‹è½®è¯¢é—´éš”3ç§’ï¼Œé¿å…è¿æ¥è¿‡å¤š
            let isChecking = false;  // é˜²æ­¢å¹¶å‘è¯·æ±‚
            
            const doStatusCheck = () => {
                // é˜²æ­¢å¹¶å‘è¯·æ±‚
                if (isChecking) {
                    return;
                }
                
                isChecking = true;
                
                fetch('/api/status', {
                    method: 'GET',
                    cache: 'no-cache',
                    headers: {
                        'Cache-Control': 'no-cache'
                    },
                    signal: AbortSignal.timeout(5000)  // 5ç§’è¶…æ—¶
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    return response.json();
                })
                .then(status => {
                    consecutiveErrors = 0;  // é‡ç½®é”™è¯¯è®¡æ•°
                    pollInterval = 3000;  // é‡ç½®è½®è¯¢é—´éš”
                    isChecking = false;
                    
                    updateStatus(status);
                    
                    // å®æ—¶æ›´æ–°å›¾ç‰‡åˆ—è¡¨
                    if (status.latest_processed && status.latest_processed.length > 0) {
                        updateImagesRealtime(status.latest_processed);
                    }
                    
                    if (!status.is_processing) {
                        // å¤„ç†å®Œæˆï¼Œåœæ­¢è½®è¯¢
                        if (statusCheckInterval) {
                            clearInterval(statusCheckInterval);
                            statusCheckInterval = null;
                        }
                        
                        const procBtn = document.getElementById('processBtn');
                        if (procBtn) {
                            procBtn.disabled = false;
                            procBtn.textContent = 'ğŸš€ å¼€å§‹å¤„ç†';
                        }
                        
                        if (status.processed_files > 0) {
                            // å¤„ç†å®Œæˆï¼ŒåŠ è½½æ‰€æœ‰å›¾ç‰‡
                            if (status.session_id) {
                                currentSessionId = status.session_id;
                            }
                            loadImages();
                        }
                    } else {
                        // å¦‚æœæ­£åœ¨å¤„ç†ï¼Œç»§ç»­ä¸‹ä¸€æ¬¡è½®è¯¢
                        setTimeout(doStatusCheck, pollInterval);
                    }
                })
                .catch(error => {
                    isChecking = false;
                    consecutiveErrors++;
                    
                    // åªè®°å½•éç½‘ç»œå˜æ›´é”™è¯¯ï¼ˆERR_NETWORK_CHANGED é€šå¸¸æ˜¯æš‚æ—¶çš„ï¼‰
                    if (!error.message.includes('Failed to fetch') && !error.name.includes('AbortError')) {
                        console.warn(`Status check error (${consecutiveErrors}/${maxErrors}):`, error);
                    }
                    
                    // å¦‚æœè¿ç»­é”™è¯¯ï¼Œé€æ¸å¢åŠ è½®è¯¢é—´éš”
                    if (consecutiveErrors > 3) {
                        pollInterval = Math.min(pollInterval * 1.2, 10000);  // æœ€å¤š10ç§’
                    }
                    
                    // å¦‚æœè¿ç»­é”™è¯¯å¤ªå¤šï¼Œåœæ­¢è½®è¯¢å¹¶æç¤ºç”¨æˆ·
                    if (consecutiveErrors >= maxErrors) {
                        console.error('è¿ç»­é”™è¯¯è¿‡å¤šï¼Œåœæ­¢çŠ¶æ€æ£€æŸ¥');
                        if (statusCheckInterval) {
                            clearInterval(statusCheckInterval);
                            statusCheckInterval = null;
                        }
                        
                        const statusMsg = document.getElementById('statusMessage');
                        if (statusMsg) {
                            statusMsg.innerHTML = '<div style="color: #f44336; padding: 10px; background: #ffebee; border-radius: 5px; margin-top: 10px;">âš ï¸ ç½‘ç»œè¿æ¥ä¸­æ–­ï¼Œè¯·åˆ·æ–°é¡µé¢æ£€æŸ¥å¤„ç†çŠ¶æ€</div>';
                        }
                        
                        const procBtn = document.getElementById('processBtn');
                        if (procBtn) {
                            procBtn.disabled = false;
                            procBtn.textContent = 'ğŸš€ å¼€å§‹å¤„ç†';
                        }
                    } else {
                        // ç»§ç»­é‡è¯•ï¼Œä½†ä½¿ç”¨æ›´é•¿çš„é—´éš”
                        setTimeout(doStatusCheck, pollInterval);
                    }
                });
            };
            
            // ç«‹å³æ‰§è¡Œç¬¬ä¸€æ¬¡æ£€æŸ¥
            doStatusCheck();
            
            // è®¾ç½®å®šæœŸæ£€æŸ¥ï¼ˆä½œä¸ºå¤‡ç”¨ï¼Œä½†é—´éš”æ›´é•¿ï¼‰
            statusCheckInterval = setInterval(doStatusCheck, Math.max(pollInterval * 2, 5000));
        }

        function updateStatus(status) {
            const currentFileEl = document.getElementById('currentFile');
            if (currentFileEl) {
                currentFileEl.textContent = status.current_file || '-';
            }
            
            const progress = status.total_files > 0 
                ? Math.round((status.processed_files / status.total_files) * 100)
                : 0;
            
            const progressEl = document.getElementById('progress');
            if (progressEl) {
                progressEl.textContent = `${status.processed_files} / ${status.total_files}`;
            }
            
            const progressFill = document.getElementById('progressFill');
            if (progressFill) {
                progressFill.style.width = progress + '%';
                progressFill.textContent = progress + '%';
            }

            const statusMessage = document.getElementById('statusMessage');
            if (!statusMessage) return;

            if (status.is_processing) {
                statusMessage.innerHTML = '<div class="loading"></div>æ­£åœ¨å¤„ç†ä¸­...';
            } else {
                // å¤„ç†å®Œæˆæˆ–å¤±è´¥
                if (status.total_files === 0 && status.errors.length > 0) {
                    // åˆå§‹åŒ–å¤±è´¥æˆ–æ²¡æœ‰æ‰¾åˆ°æ–‡ä»¶
                    let errorText = '<div class="error-message">';
                    errorText += '<strong>å¤„ç†å¤±è´¥ï¼</strong><br>';
                    status.errors.forEach(err => {
                        errorText += 'â€¢ ' + err + '<br>';
                    });
                    errorText += '</div>';
                    statusMessage.innerHTML = errorText;
                } else if (status.processed_files > 0) {
                    if (status.errors.length > 0) {
                        let errorText = '<div class="error-message">';
                        errorText += 'å¤„ç†å®Œæˆï¼Œä½†æœ‰ ' + status.errors.length + ' ä¸ªé”™è¯¯ï¼š<br>';
                        status.errors.slice(0, 5).forEach(err => {
                            errorText += 'â€¢ ' + err + '<br>';
                        });
                        if (status.errors.length > 5) {
                            errorText += '... è¿˜æœ‰ ' + (status.errors.length - 5) + ' ä¸ªé”™è¯¯';
                        }
                        errorText += '</div>';
                        statusMessage.innerHTML = errorText;
                    } else {
                        statusMessage.innerHTML = 
                            '<div class="success-message">âœ… å…¨éƒ¨å¤„ç†å®Œæˆï¼</div>';
                    }
                } else if (status.errors.length > 0) {
                    // å¤„ç†å¤±è´¥ä½†æ²¡æœ‰å¤„ç†ä»»ä½•æ–‡ä»¶
                    let errorText = '<div class="error-message">';
                    errorText += '<strong>å¤„ç†å¤±è´¥ï¼</strong><br>';
                    status.errors.forEach(err => {
                        errorText += 'â€¢ ' + err + '<br>';
                    });
                    errorText += '</div>';
                    statusMessage.innerHTML = errorText;
                } else {
                    // æœªå¤„ç†ä»»ä½•æ–‡ä»¶ï¼Œä¸”æ²¡æœ‰é”™è¯¯ï¼ˆå¯èƒ½æ˜¯åˆå§‹åŒ–æˆ–ç­‰å¾…çŠ¶æ€ï¼‰
                    statusMessage.innerHTML = '<div class="info-message">ç­‰å¾…å¼€å§‹å¤„ç†...</div>';
                }
            }
        }

        function loadImages() {
            if (!currentSessionId && !currentOutputFolder) return;

            let url = '/api/images?';
            if (currentSessionId) {
                url += `session_id=${encodeURIComponent(currentSessionId)}`;
            } else if (currentOutputFolder) {
                url += `folder=${encodeURIComponent(currentOutputFolder)}`;
            }

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    allImagesData = data.images;  // ä¿å­˜å›¾ç‰‡æ•°æ®
                    displayImages(data.images);
                })
                .catch(error => {
                    console.error('Load images error:', error);
                });
        }

        function displayImages(images) {
            const grid = document.getElementById('imagesGrid');
            const imagesSection = document.getElementById('imagesSection');
            const fileManagerContainer = document.getElementById('fileManagerContainer');
            const thumbnailList = document.getElementById('thumbnailList');
            
            console.log('Displaying images:', images.length);
            
            // ç¡®ä¿å›¾ç‰‡åŒºåŸŸæ˜¾ç¤º
            imagesSection.style.display = 'block';
            
            if (images.length === 0) {
                fileManagerContainer.style.display = 'none';
                grid.style.display = 'block';
                grid.innerHTML = `
                    <div class="empty-state">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                            <rect x="3" y="3" width="18" height="18" rx="2" stroke-width="2"/>
                            <path d="M9 9h6v6H9z" stroke-width="2"/>
                        </svg>
                        <p>æš‚æ— å¤„ç†ç»“æœ</p>
                    </div>
                `;
                updateSelectedCount();
                return;
            }

            // æ˜¾ç¤ºæ–‡ä»¶ç®¡ç†å™¨
            fileManagerContainer.style.display = 'flex';
            grid.style.display = 'none';

            // ç”Ÿæˆç¼©ç•¥å›¾åˆ—è¡¨
            thumbnailList.innerHTML = images.map((img, index) => {
                const fixedUrl = `/api/image?path=${encodeURIComponent(img.fixed)}`;
                const isSelected = selectedImages.has(img.name);
                const isActive = index === currentPreviewIndex;
                const imgNameEscaped = img.name.replace(/'/g, "\\'");

                return `
                    <div class="thumbnail-item ${isActive ? 'active' : ''}" 
                         onclick="showPreview(${index})"
                         data-index="${index}">
                        <input type="checkbox" class="thumbnail-checkbox" ${isSelected ? 'checked' : ''} 
                               onclick="event.stopPropagation(); toggleImage('${imgNameEscaped}', ${index})">
                        <img src="${fixedUrl}" alt="${img.name}" 
                             onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2260%22 height=%2260%22%3E%3Crect fill=%22%23ddd%22 width=%2260%22 height=%2260%22/%3E%3Ctext x=%2230%22 y=%2230%22 text-anchor=%22middle%22 fill=%22%23999%22%3Eå›¾ç‰‡%3C/text%3E%3C/svg%3E'">
                        <div class="thumbnail-info">
                            <div class="thumbnail-name" title="${img.name}">${img.name.replace('_clear.jpg', '')}</div>
                        </div>
                    </div>
                `;
            }).join('');

            // é»˜è®¤æ˜¾ç¤ºç¬¬ä¸€å¼ å›¾ç‰‡
            if (images.length > 0 && currentPreviewIndex === -1) {
                showPreview(0);
            }

            updateSelectedCount();
            
            // å¯ç”¨æŒ‰é’®
            const selectAllBtn2 = document.getElementById('selectAllBtn');
            const deselectAllBtn2 = document.getElementById('deselectAllBtn');
            const saveReadyBtn2 = document.getElementById('saveReadyBtn');
            const saveReprocessBtn2 = document.getElementById('saveReprocessBtn');
            
            if (selectAllBtn2) selectAllBtn2.disabled = false;
            if (deselectAllBtn2) deselectAllBtn2.disabled = false;
            if (saveReadyBtn2) saveReadyBtn2.disabled = false;
            if (saveReprocessBtn2) saveReprocessBtn2.disabled = false;
        }

        function showPreview(index) {
            if (!allImagesData || index < 0 || index >= allImagesData.length) return;

            currentPreviewIndex = index;
            const img = allImagesData[index];
            const previewContent = document.getElementById('previewContent');
            
            const originalUrl = img.original 
                ? `/api/image?path=${encodeURIComponent(img.original)}`
                : null;
            const fixedUrl = `/api/image?path=${encodeURIComponent(img.fixed)}`;

            // æ›´æ–°ç¼©ç•¥å›¾æ¿€æ´»çŠ¶æ€
            document.querySelectorAll('.thumbnail-item').forEach((item, i) => {
                if (i === index) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });

            // æ˜¾ç¤ºé¢„è§ˆï¼ˆä¸Šä¸‹å¸ƒå±€ï¼‰
            previewContent.innerHTML = `
                <div class="preview-comparison">
                    <div class="preview-image-wrapper">
                        <div class="preview-label" style="margin-bottom: 10px;">å¤„ç†å‰ï¼ˆåŸå›¾ï¼‰</div>
                        ${originalUrl 
                            ? `<img src="${originalUrl}" alt="åŸå›¾" onerror="this.parentElement.innerHTML='<div style=\\'padding:40px;text-align:center;color:#999\\'>åŸå›¾æœªæ‰¾åˆ°</div>'">`
                            : '<div style="padding:40px;text-align:center;color:#999;min-height:300px;display:flex;align-items:center;justify-content:center;">åŸå›¾æœªæ‰¾åˆ°</div>'
                        }
                    </div>
                    <div class="preview-image-wrapper">
                        <div class="preview-label" style="margin-bottom: 10px;">å¤„ç†åï¼ˆä¿®å¤åï¼‰</div>
                        <img src="${fixedUrl}" alt="ä¿®å¤å" onerror="this.parentElement.innerHTML='<div style=\\'padding:40px;text-align:center;color:#999\\'>å›¾ç‰‡åŠ è½½å¤±è´¥</div>'">
                    </div>
                </div>
                <div style="margin-top: 15px; text-align: center; color: #666;">
                    <strong>æ–‡ä»¶åï¼š</strong>${img.name}
                </div>
            `;
        }

        function toggleImage(imgName, index) {
            if (selectedImages.has(imgName)) {
                selectedImages.delete(imgName);
            } else {
                selectedImages.add(imgName);
            }
            updateSelectedCount();
            
            // æ›´æ–°ç¼©ç•¥å›¾çš„å¤é€‰æ¡†çŠ¶æ€
            const thumbnailItems = document.querySelectorAll('.thumbnail-item');
            if (thumbnailItems[index]) {
                const checkbox = thumbnailItems[index].querySelector('.thumbnail-checkbox');
                if (checkbox) {
                    checkbox.checked = selectedImages.has(imgName);
                }
            }
        }

        function selectAll() {
            if (!allImagesData) return;
            allImagesData.forEach(img => {
                selectedImages.add(img.name);
            });
            updateThumbnailSelection();
            updateSelectedCount();
        }

        function deselectAll() {
            selectedImages.clear();
            updateThumbnailSelection();
            updateSelectedCount();
        }

        function updateThumbnailSelection() {
            const thumbnailItems = document.querySelectorAll('.thumbnail-item');
            thumbnailItems.forEach((item, index) => {
                if (allImagesData && allImagesData[index]) {
                    const imgName = allImagesData[index].name;
                    const checkbox = item.querySelector('.thumbnail-checkbox');
                    if (checkbox) {
                        checkbox.checked = selectedImages.has(imgName);
                    }
                }
            });
        }

        function updateSelectedCount() {
            const count = selectedImages.size;
            const countEl = document.getElementById('selectedCount');
            if (countEl) {
                if (count > 0) {
                    countEl.textContent = `âœ“ å·²é€‰æ‹© ${count} å¼ å›¾ç‰‡`;
                    countEl.style.background = '#e8f5e9';
                    countEl.style.color = '#2e7d32';
                } else {
                    const totalImages = allImagesData ? allImagesData.length : 0;
                    if (totalImages > 0) {
                        countEl.textContent = `æœªé€‰æ‹©ä»»ä½•å›¾ç‰‡ï¼ˆä¿å­˜æ—¶å°†ä¿å­˜æ‰€æœ‰ ${totalImages} å¼ å›¾ç‰‡ï¼‰`;
                        countEl.style.background = '#fff3e0';
                        countEl.style.color = '#e65100';
                    } else {
                        countEl.textContent = 'ç­‰å¾…å¤„ç†å®Œæˆ...';
                        countEl.style.background = '#E6F4FD';
                        countEl.style.color = '#5A9FD8';
                    }
                }
            }
        }

        function saveSelected(folderType) {
            if (!currentSessionId) {
                alert('é”™è¯¯: ç¼ºå°‘ä¼šè¯ID');
                return;
            }

            const selectedList = Array.from(selectedImages);
            const folderTypeName = folderType === 'reprocess' ? 'éœ€è¦å†æ¬¡å¤„ç†' : 'ç›´æ¥æŠ•å…¥ä½¿ç”¨';
            const btnId = folderType === 'reprocess' ? 'saveReprocessBtn' : 'saveReadyBtn';
            const saveBtn = document.getElementById(btnId);
            if (!saveBtn) {
                alert('é”™è¯¯: æ‰¾ä¸åˆ°ä¿å­˜æŒ‰é’®');
                return;
            }
            const originalText = saveBtn.textContent;
            saveBtn.disabled = true;
            saveBtn.textContent = 'ğŸ’¾ ä¿å­˜ä¸­...';

            fetch('/api/save', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    session_id: currentSessionId,
                    selected_images: selectedList,
                    folder_type: folderType
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(`âœ… ä¿å­˜æˆåŠŸï¼\nå·²ä¿å­˜ ${data.saved_count} å¼ å›¾ç‰‡åˆ°:\n${data.output_folder}`);
                    if (data.errors && data.errors.length > 0) {
                        console.warn('ä¿å­˜æ—¶çš„é”™è¯¯:', data.errors);
                    }
                } else {
                    alert('ä¿å­˜å¤±è´¥: ' + data.message);
                }
                saveBtn.disabled = false;
                saveBtn.textContent = originalText;
            })
            .catch(error => {
                console.error('Save error:', error);
                alert('ä¿å­˜æ—¶å‡ºé”™: ' + error.message);
                saveBtn.disabled = false;
                saveBtn.textContent = originalText;
            });
        }

        function updateImagesRealtime(newImages) {
            if (!newImages || newImages.length === 0) return;
            
            const thumbnailList = document.getElementById('thumbnailList');
            const fileManagerContainer = document.getElementById('fileManagerContainer');
            
            // ç¡®ä¿æ–‡ä»¶ç®¡ç†å™¨æ˜¾ç¤º
            fileManagerContainer.style.display = 'flex';
            document.getElementById('imagesGrid').style.display = 'none';
            
            // åˆå¹¶æ–°å›¾ç‰‡åˆ°ç°æœ‰æ•°æ®
            newImages.forEach(newImg => {
                // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
                const exists = allImagesData.some(img => img.name === newImg.name);
                if (!exists) {
                    allImagesData.push(newImg);
                }
            });
            
            // é‡æ–°ç”Ÿæˆç¼©ç•¥å›¾åˆ—è¡¨
            displayImages(allImagesData);
            
            // å¦‚æœå½“å‰æ²¡æœ‰é¢„è§ˆï¼Œè‡ªåŠ¨æ˜¾ç¤ºæœ€æ–°çš„ä¸€å¼ 
            if (currentPreviewIndex === -1 && allImagesData.length > 0) {
                showPreview(allImagesData.length - 1);
            }
        }

        // æ˜¾ç¤ºä»»åŠ¡æŠ¥å‘Š
        function showTaskReport() {
            fetch('/api/task_report')
                .then(response => response.json())
                .then(report => {
                    let reportHtml = `
                        <div style="max-width: 800px; margin: 0 auto; padding: 20px;">
                            <h2 style="color: #5A9FD8; margin-bottom: 20px;">ğŸ“Š ä»»åŠ¡è¯¦ç»†æŠ¥å‘Š</h2>
                            
                            <div style="background: white; border-radius: 10px; padding: 20px; margin-bottom: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                                <h3 style="color: #333; margin-top: 0;">çŠ¶æ€æ¦‚è§ˆ</h3>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                    <div>
                                        <strong>å¤„ç†çŠ¶æ€:</strong> 
                                        <span style="color: ${report.is_processing ? '#ff9800' : (report.errors.length > 0 ? '#f44336' : '#4caf50')};">
                                            ${report.status_summary}
                                        </span>
                                    </div>
                                    <div>
                                        <strong>è¿›åº¦:</strong> ${report.processed_files} / ${report.total_files} (${report.progress_percent}%)
                                    </div>
                                    <div>
                                        <strong>å½“å‰æ–‡ä»¶:</strong> ${report.current_file || '-'}
                                    </div>
                                    <div>
                                        <strong>é”™è¯¯æ•°é‡:</strong> 
                                        <span style="color: ${report.errors.length > 0 ? '#f44336' : '#4caf50'};">
                                            ${report.errors.length}
                                        </span>
                                    </div>
                                </div>
                            </div>
                            
                            ${report.input_folder ? `
                            <div style="background: white; border-radius: 10px; padding: 20px; margin-bottom: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                                <h3 style="color: #333; margin-top: 0;">è·¯å¾„ä¿¡æ¯</h3>
                                <div style="word-break: break-all;">
                                    <div style="margin-bottom: 10px;">
                                        <strong>è¾“å…¥æ–‡ä»¶å¤¹:</strong><br>
                                        <code style="background: #f5f5f5; padding: 5px 10px; border-radius: 5px;">${report.input_folder}</code>
                                    </div>
                                    ${report.temp_folder ? `
                                    <div>
                                        <strong>ä¸´æ—¶æ–‡ä»¶å¤¹:</strong><br>
                                        <code style="background: #f5f5f5; padding: 5px 10px; border-radius: 5px;">${report.temp_folder}</code>
                                    </div>
                                    ` : ''}
                                </div>
                            </div>
                            ` : ''}
                            
                            ${report.errors.length > 0 ? `
                            <div style="background: #ffebee; border-left: 4px solid #f44336; border-radius: 10px; padding: 20px; margin-bottom: 15px;">
                                <h3 style="color: #c62828; margin-top: 0;">âŒ é”™è¯¯åˆ—è¡¨ (${report.errors.length})</h3>
                                <div style="max-height: 400px; overflow-y: auto;">
                                    <ol style="margin: 0; padding-left: 20px;">
                                        ${report.errors.map((err, idx) => `
                                            <li style="margin-bottom: 10px; color: #333;">
                                                <code style="background: white; padding: 5px 10px; border-radius: 5px; display: block; margin-top: 5px;">${err}</code>
                                            </li>
                                        `).join('')}
                                    </ol>
                                </div>
                            </div>
                            ` : ''}
                            
                            <div style="text-align: center; margin-top: 20px;">
                                <button class="btn" onclick="document.getElementById('reportModal').style.display='none'" style="padding: 10px 30px;">
                                    å…³é—­
                                </button>
                            </div>
                        </div>
                    `;
                    
                    // åˆ›å»ºæˆ–æ›´æ–°æ¨¡æ€æ¡†
                    let modal = document.getElementById('reportModal');
                    if (!modal) {
                        modal = document.createElement('div');
                        modal.id = 'reportModal';
                        modal.style.cssText = 'display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5);';
                        modal.innerHTML = `
                            <div style="background-color: #fefefe; margin: 5% auto; padding: 0; border-radius: 15px; width: 90%; max-width: 900px; max-height: 90vh; overflow-y: auto; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
                                <div style="padding: 20px; border-bottom: 2px solid #7EBEFB; display: flex; justify-content: space-between; align-items: center;">
                                    <h2 style="margin: 0; color: #5A9FD8;">ä»»åŠ¡æŠ¥å‘Š</h2>
                                    <span onclick="document.getElementById('reportModal').style.display='none'" style="color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer;">&times;</span>
                                </div>
                                <div id="reportContent"></div>
                            </div>
                        `;
                        document.body.appendChild(modal);
                    }
                    
                    document.getElementById('reportContent').innerHTML = reportHtml;
                    modal.style.display = 'block';
                })
                .catch(error => {
                    console.error('è·å–ä»»åŠ¡æŠ¥å‘Šå¤±è´¥:', error);
                    alert('è·å–ä»»åŠ¡æŠ¥å‘Šå¤±è´¥: ' + error.message);
                });
        }

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        window.onclick = function(event) {
            const modal = document.getElementById('reportModal');
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        }

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥æ˜¯å¦æœ‰æ­£åœ¨è¿›è¡Œçš„ä»»åŠ¡
        window.onload = function() {
            fetch('/api/status')
                .then(response => response.json())
                .then(status => {
                    if (status.is_processing) {
                        document.getElementById('statusSection').style.display = 'block';
                        const procBtn2 = document.getElementById('processBtn');
                        if (procBtn2) {
                            procBtn2.disabled = true;
                            procBtn2.textContent = 'â³ å¤„ç†ä¸­...';
                        }
                        if (status.session_id) {
                            currentSessionId = status.session_id;
                        }
                        startStatusCheck();
                    }
                });
        };
    </script>
</body>
</html>

